<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLEARN - NEET Preparation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tlearn-bg {
            background-color: #0d0d0d; /* Darker background for more contrast */
        }
        .tlearn-red {
            background-color: #E50914;
        }
        .tlearn-red-text {
            color: #E50914;
        }
        
        /* --- Lock Screen Styles --- */
        #lock-screen {
            background-color: #000;
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        .aurora-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            filter: blur(100px) saturate(150%);
        }

        .aurora-element {
            position: absolute;
            border-radius: 50%;
            animation: move 20s infinite alternate;
        }

        .aurora-element:nth-child(1) {
            width: 50vw; height: 50vw; max-width: 500px; max-height: 500px;
            background: radial-gradient(circle, rgba(229,9,20,0.5) 0%, rgba(229,9,20,0) 70%);
            top: -20%; left: -10%; animation-duration: 18s;
        }
        .aurora-element:nth-child(2) {
            width: 60vw; height: 60vw; max-width: 600px; max-height: 600px;
            background: radial-gradient(circle, rgba(48,43,99,0.5) 0%, rgba(48,43,99,0) 70%);
            bottom: -30%; right: -20%; animation-duration: 25s;
        }
        .aurora-element:nth-child(3) {
            width: 40vw; height: 40vw; max-width: 400px; max-height: 400px;
            background: radial-gradient(circle, rgba(0, 255, 159, 0.3) 0%, rgba(36,36,62,0) 70%);
            top: 10%; right: 10%; animation-duration: 22s;
        }

        @keyframes move {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(100px, 50px) rotate(45deg); }
        }
        
        .glassmorphism-box {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        #password-input:focus {
            box-shadow: 0 0 15px rgba(229, 9, 20, 0.7);
            border-color: #E50914;
        }

        /* --- Welcome Screen Animations --- */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-down { animation: fadeInDown 1.5s ease-out forwards; }
        .fade-in-up { animation: fadeInUp 1.5s ease-out 0.5s forwards; opacity: 0; }
        
        /* --- Modal Styles --- */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1f1f1f; margin: 5% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 900px;
            border-radius: 10px; max-height: 90vh; overflow-y: auto;
        }
        .close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close:hover, .close:focus {
            color: white; text-decoration: none; cursor: pointer;
        }
        .correct-answer {
            background-color: rgba(4, 120, 87, 0.3); padding: 2px 4px; border-radius: 4px;
        }
        .incorrect-answer {
            background-color: rgba(224, 62, 62, 0.3); padding: 2px 4px; border-radius: 4px; text-decoration: line-through;
        }
        select {
            background-color: #2d3748; color: white;
        }

        /* --- Attractive Dashboard Styles --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .action-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        .main-dashboard-bg {
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.1) 1px, transparent 0);
            background-size: 2rem 2rem;
            animation: bg-pan 30s linear infinite;
        }
        @keyframes bg-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        /* Mic button listening animation */
        .mic-listening {
            box-shadow: 0 0 15px 5px rgba(229, 9, 20, 0.7);
        }
    </style>
</head>
<body class="tlearn-bg text-white">

    <!-- Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="aurora-container">
            <div class="aurora-element"></div>
            <div class="aurora-element"></div>
            <div class="aurora-element"></div>
        </div>
        <div class="glassmorphism-box p-8 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-4">Thanu â€“ Unlock to Learn More</h1>
            <p class="text-gray-400 mb-6">Enter Passcode</p>
            <input type="password" id="password-input" class="w-full bg-gray-800 text-white p-3 rounded-md text-center tracking-widest text-2xl border-2 border-transparent transition-all duration-300" maxlength="8">
            <p id="error-message" class="text-red-500 mt-4 hidden">Incorrect Passcode</p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-black hidden">
        <div class="text-center p-4">
            <h1 id="welcome-greet" class="text-4xl md:text-6xl font-bold"></h1>
            <p id="welcome-subtext" class="text-xl md:text-2xl text-gray-400 mt-4"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden main-dashboard-bg">
        <header class="sticky top-0 z-50 p-4 flex justify-between items-center glass-panel mx-4 mt-4">
             <h1 class="text-3xl font-bold tlearn-red-text"><span class="text-4xl">T</span>LEARN</h1>
             <button id="icon-history-btn" class="bg-gray-700/50 hover:bg-gray-600/50 p-2 rounded-full transition-colors">
                <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             </button>
        </header>

        <main class="p-4 md:p-8">
            <h2 class="text-4xl font-bold mb-8 text-center">What will you conquer today, Thanu?</h2>
            
            <div class="flex items-center justify-center flex-wrap gap-3 mb-8">
                <button id="study-plan-btn" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full text-sm">âœ¨ Study Plan</button>
                <button id="chapter-test-btn" class="action-button bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full text-sm">Chapter Test</button>
                <button id="chapter-exp-btn" class="action-button bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-full text-sm">Chapter Explanation</button>
                <button id="subject-test-btn" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full text-sm">Subject Test</button>
                <button id="mock-test-btn" class="action-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">Full Mock Test</button>
            </div>

            <!-- Search Section -->
            <div class="glass-panel p-6 md:p-10 text-center mb-12">
                <h3 class="text-2xl font-bold mb-4">Explore a Concept</h3>
                <div class="relative max-w-4xl mx-auto">
                    <button id="mic-btn" class="absolute inset-y-0 left-0 pl-4 flex items-center cursor-pointer">
                        <svg class="h-6 w-6 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                    <input type="text" id="search-input" class="w-full bg-gray-800 text-white p-4 rounded-full text-lg focus:outline-none focus:ring-2 focus:ring-red-500 pl-14 pr-32">
                    
                    <div class="absolute inset-y-0 right-0 flex items-center pr-4 space-x-3">
                        <!-- NEW: Camera Button -->
                        <button id="camera-btn" class="cursor-pointer">
                            <svg class="h-6 w-6 text-gray-400 hover:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                            </svg>
                        </button>
                        <input type="file" id="file-upload-input" class="hidden" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx">
                        <button id="upload-btn" class="cursor-pointer">
                            <svg class="h-6 w-6 text-gray-400 hover:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" />
                            </svg>
                        </button>
                        <button id="clear-search-btn" class="cursor-pointer hidden">
                            <svg class="h-6 w-6 text-gray-500 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="file-display-area" class="mt-3 text-center"></div>
                 <button id="search-btn" class="w-full md:w-auto mt-4 tlearn-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg">Search</button>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden my-8">
                <div id="gemini-response" class="p-6 glass-panel"></div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="study-plan-modal" class="modal">
        <div class="modal-content">
            <span id="close-study-plan" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">âœ¨ AI Study Plan Generator</h2>
            <div class="space-y-4">
                <div>
                    <label for="study-weeks" class="block text-sm font-medium text-gray-300">Number of Weeks to Study:</label>
                    <input type="number" id="study-weeks" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" value="8">
                </div>
                <div>
                    <label for="study-subjects" class="block text-sm font-medium text-gray-300">Subjects to Focus On (comma-separated):</label>
                    <input type="text" id="study-subjects" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" placeholder="e.g., Physics, Organic Chemistry">
                </div>
                <button id="generate-plan-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md">Generate Plan</button>
            </div>
            <div id="study-plan-output" class="mt-6 p-4 bg-gray-900 rounded-lg min-h-[200px] text-gray-300 whitespace-pre-wrap"></div>
        </div>
    </div>

    <div id="mock-test-modal" class="modal">
        <div class="modal-content">
            <span id="close-mock-test" class="close">&times;</span>
            <div id="mock-test-content"></div>
        </div>
    </div>

    <div id="subject-test-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span id="close-subject-test" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">Choose a Subject</h2>
            <div id="subject-choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button class="subject-choice-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Physics">Physics</button>
                <button class="subject-choice-btn bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Chemistry">Chemistry</button>
                <button class="subject-choice-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Botany">Botany</button>
                <button class="subject-choice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Zoology">Zoology</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="close-history" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">My Learning History</h2>
            <div id="history-content"></div>
        </div>
    </div>

    <div id="chapter-test-modal" class="modal">
        <div class="modal-content">
            <span id="close-chapter-test" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">ðŸŽ¯ Chapter-wise Test</h2>
            <div class="space-y-4">
                 <div>
                    <label for="chapter-test-year" class="block text-sm font-medium text-gray-300">Year:</label>
                    <select id="chapter-test-year" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1">
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                    </select>
                </div>
                <div>
                    <label for="chapter-test-subject" class="block text-sm font-medium text-gray-300">Subject:</label>
                    <select id="chapter-test-subject" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <div>
                    <label for="chapter-test-chapter" class="block text-sm font-medium text-gray-300">Chapter:</label>
                    <select id="chapter-test-chapter" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <button id="start-chapter-test-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-md">Start Chapter Test</button>
            </div>
        </div>
    </div>

    <div id="chapter-explanation-modal" class="modal">
        <div class="modal-content">
            <span id="close-chapter-explanation" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">ðŸ§  Chapter-wise Explanation</h2>
            <div class="space-y-4">
                 <div>
                    <label for="chapter-exp-year" class="block text-sm font-medium text-gray-300">Year:</label>
                    <select id="chapter-exp-year" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1">
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                    </select>
                </div>
                <div>
                    <label for="chapter-exp-subject" class="block text-sm font-medium text-gray-300">Subject:</label>
                    <select id="chapter-exp-subject" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <div>
                    <label for="chapter-exp-chapter" class="block text-sm font-medium text-gray-300">Chapter:</label>
                    <select id="chapter-exp-chapter" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                 <div>
                    <label for="chapter-exp-topic" class="block text-sm font-medium text-gray-300">Specific Topic (Optional):</label>
                    <input type="text" id="chapter-exp-topic" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" placeholder="e.g., Glycolysis steps">
                </div>
                <button id="get-explanation-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-md">Get Explanation</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Camera Modal -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <span id="close-camera" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-center">Capture Photo</h2>
            <video id="camera-feed" class="w-full rounded-lg" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <button id="snap-photo-btn" class="w-full mt-4 tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Snap Photo</button>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Application State ---
        let db, auth, userId, appId;
        let unsubscribeTestHistory, unsubscribeSearchHistory, unsubscribeExplanationHistory;
        let currentTestQuestions = [];
        let combinedHistory = [];
        let timerInterval = null;
        let testStartTime = 0;
        let currentTestType = '';
        let lastGreetingIndex = -1;
        let uploadedFileContent = null;
        let cameraStream = null;

        // --- IMPORTANT: API KEY MANAGEMENT ---
        const geminiApiKey = "AIzaSyD_Dxv-dgdv8PYp97-F74dM0day1FEA8Do"; 

        // --- DOM Elements Cache ---
        const ui = {
            passwordInput: document.getElementById('password-input'),
            lockScreen: document.getElementById('lock-screen'),
            welcomeScreen: document.getElementById('welcome-screen'),
            mainDashboard: document.getElementById('main-dashboard'),
            errorMessage: document.getElementById('error-message'),
            welcomeGreet: document.getElementById('welcome-greet'),
            welcomeSubtext: document.getElementById('welcome-subtext'),
            searchBtn: document.getElementById('search-btn'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            micBtn: document.getElementById('mic-btn'),
            uploadBtn: document.getElementById('upload-btn'),
            cameraBtn: document.getElementById('camera-btn'),
            fileUploadInput: document.getElementById('file-upload-input'),
            fileDisplayArea: document.getElementById('file-display-area'),
            resultsSection: document.getElementById('results-section'),
            geminiResponseEl: document.getElementById('gemini-response'),
            mockTestBtn: document.getElementById('mock-test-btn'),
            subjectTestBtn: document.getElementById('subject-test-btn'),
            historyBtn: document.getElementById('icon-history-btn'),
            studyPlanBtn: document.getElementById('study-plan-btn'),
            chapterTestBtn: document.getElementById('chapter-test-btn'),
            chapterExpBtn: document.getElementById('chapter-exp-btn'),
            mockTestModal: document.getElementById('mock-test-modal'),
            subjectTestModal: document.getElementById('subject-test-modal'),
            historyModal: document.getElementById('history-modal'),
            studyPlanModal: document.getElementById('study-plan-modal'),
            chapterTestModal: document.getElementById('chapter-test-modal'),
            chapterExplanationModal: document.getElementById('chapter-explanation-modal'),
            cameraModal: document.getElementById('camera-modal'),
            closeMockTest: document.getElementById('close-mock-test'),
            closeSubjectTest: document.getElementById('close-subject-test'),
            closeHistory: document.getElementById('close-history'),
            closeStudyPlan: document.getElementById('close-study-plan'),
            closeChapterTest: document.getElementById('close-chapter-test'),
            closeChapterExplanation: document.getElementById('close-chapter-explanation'),
            closeCamera: document.getElementById('close-camera'),
            mockTestContent: document.getElementById('mock-test-content'),
            subjectChoiceContainer: document.getElementById('subject-choice-container'),
            historyContent: document.getElementById('history-content'),
            generatePlanBtn: document.getElementById('generate-plan-btn'),
            studyPlanOutput: document.getElementById('study-plan-output'),
            studyWeeks: document.getElementById('study-weeks'),
            studySubjects: document.getElementById('study-subjects'),
            chapterTestYear: document.getElementById('chapter-test-year'),
            chapterTestSubject: document.getElementById('chapter-test-subject'),
            chapterTestChapter: document.getElementById('chapter-test-chapter'),
            startChapterTestBtn: document.getElementById('start-chapter-test-btn'),
            chapterExpYear: document.getElementById('chapter-exp-year'),
            chapterExpSubject: document.getElementById('chapter-exp-subject'),
            chapterExpChapter: document.getElementById('chapter-exp-chapter'),
            chapterExpTopic: document.getElementById('chapter-exp-topic'),
            getExplanationBtn: document.getElementById('get-explanation-btn'),
            cameraFeed: document.getElementById('camera-feed'),
            cameraCanvas: document.getElementById('camera-canvas'),
            snapPhotoBtn: document.getElementById('snap-photo-btn'),
        };

        const specialGreetings = [
            { main: "Welcome, Thanu!", sub: "Ready to show those MCQs who's boss?" },
            { main: "Hello, Superstar!", sub: "Another day, another step closer to that white coat." },
            { main: "Thanu is in the house!", sub: "Let's turn that brainpower up to 11." },
            { main: "Hey there, Future Dr. Thanu!", sub: "Your journey is inspiring. Let's keep going!" },
            { main: "It's a great day to study!", sub: "Let's make some magic happen, Thanu." }
        ];

        const syllabus = {
            "1st Year": {
                "Physics": ["Units and Measurements", "Motion in a Straight Line", "Motion in a Plane", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Mechanical Properties of Solids", "Mechanical Properties of Fluids", "Thermal Properties of Matter", "Thermodynamics", "Kinetic Theory", "Oscillations", "Waves"],
                "Chemistry": ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements and Periodicity in Properties", "Chemical Bonding and Molecular Structure", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "The s-Block Elements", "The p-Block Elements (Groups 13 & 14)", "Organic Chemistry: Some Basic Principles and Techniques", "Hydrocarbons", "Environmental Chemistry"],
                "Botany": ["The Living World", "Biological Classification", "Plant Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Transport in Plants", "Mineral Nutrition", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development"],
                "Zoology": ["Animal Kingdom", "Structural Organisation in Animals", "Digestion and Absorption", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"]
            },
            "2nd Year": {
                "Physics": ["Electric Charges and Fields", "Electrostatic Potential and Capacitance", "Current Electricity", "Moving Charges and Magnetism", "Magnetism and Matter", "Electromagnetic Induction", "Alternating Current", "Electromagnetic Waves", "Ray Optics and Optical Instruments", "Wave Optics", "Dual Nature of Radiation and Matter", "Atoms", "Nuclei", "Semiconductor Electronics: Materials, Devices and Simple Circuits"],
                "Chemistry": ["The Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "General Principles and Processes of Isolation of Elements", "The p-Block Elements (Groups 15-18)", "The d- and f-Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Amines", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
                "Botany": ["Reproduction in Organisms", "Sexual Reproduction in Flowering Plants", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"],
                "Zoology": ["Human Reproduction", "Reproductive Health", "Evolution", "Human Health and Disease", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"]
            }
        };

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            ui.passwordInput.addEventListener('input', (e) => {
                if (e.target.value.length === 8) handleLogin(e.target.value);
            });
            ui.searchBtn.addEventListener('click', handleSearch);
            
            ui.searchInput.addEventListener('input', () => {
                const hasText = ui.searchInput.value.trim() !== '';
                const hasFile = uploadedFileContent !== null;
                ui.clearSearchBtn.classList.toggle('hidden', !hasText && !hasFile);
            });
            ui.clearSearchBtn.addEventListener('click', handleClearSearch);
            ui.micBtn.addEventListener('click', handleVoiceSearch);
            ui.uploadBtn.addEventListener('click', () => ui.fileUploadInput.click());
            ui.fileUploadInput.addEventListener('change', handleFileUpload);
            ui.cameraBtn.addEventListener('click', openCamera);
            ui.snapPhotoBtn.addEventListener('click', snapPhoto);

            ui.mockTestBtn.addEventListener('click', () => {
                resetFullTestModal();
                ui.mockTestModal.style.display = 'block';
            });
            ui.subjectTestBtn.addEventListener('click', () => ui.subjectTestModal.style.display = 'block');
            ui.subjectChoiceContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('subject-choice-btn')) {
                    const subject = e.target.dataset.subject;
                    ui.subjectTestModal.style.display = 'none';
                    startSubjectTest(subject);
                }
            });
            ui.historyBtn.addEventListener('click', () => ui.historyModal.style.display = 'block');
            ui.studyPlanBtn.addEventListener('click', () => ui.studyPlanModal.style.display = 'block');
            ui.generatePlanBtn.addEventListener('click', handleGenerateStudyPlan);
            
            ui.chapterTestBtn.addEventListener('click', () => ui.chapterTestModal.style.display = 'block');
            ui.chapterExpBtn.addEventListener('click', () => ui.chapterExplanationModal.style.display = 'block');
            ui.startChapterTestBtn.addEventListener('click', startChapterTest);
            ui.getExplanationBtn.addEventListener('click', handleChapterExplanation);

            ui.closeMockTest.addEventListener('click', () => ui.mockTestModal.style.display = 'none');
            ui.closeSubjectTest.addEventListener('click', () => ui.subjectTestModal.style.display = 'none');
            ui.closeHistory.addEventListener('click', () => ui.historyModal.style.display = 'none');
            ui.closeStudyPlan.addEventListener('click', () => ui.studyPlanModal.style.display = 'none');
            ui.closeChapterTest.addEventListener('click', () => ui.chapterTestModal.style.display = 'none');
            ui.closeChapterExplanation.addEventListener('click', () => ui.chapterExplanationModal.style.display = 'none');
            ui.closeCamera.addEventListener('click', closeCamera);
            
            window.addEventListener('click', (event) => {
                const modals = [ui.mockTestModal, ui.historyModal, ui.subjectTestModal, ui.studyPlanModal, ui.chapterTestModal, ui.chapterExplanationModal, ui.cameraModal];
                modals.forEach(modal => {
                    if (event.target == modal) {
                        if (modal === ui.cameraModal) closeCamera();
                        else modal.style.display = 'none';
                    }
                });
            });

            ui.chapterTestYear.addEventListener('change', () => populateFilters('chapter-test'));
            ui.chapterTestSubject.addEventListener('change', () => populateFilters('chapter-test'));
            ui.chapterExpYear.addEventListener('change', () => populateFilters('chapter-exp'));
            ui.chapterExpSubject.addEventListener('change', () => populateFilters('chapter-exp'));
        }

        // --- Core Application Logic ---
        function getPersonalizedGreeting() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * specialGreetings.length);
            } while (newIndex === lastGreetingIndex);
            lastGreetingIndex = newIndex;
            return specialGreetings[newIndex];
        }

        async function handleLogin(password) {
            if (password === '02102008') {
                await initFirebase(); 
                ui.lockScreen.style.opacity = 0;
                setTimeout(() => ui.lockScreen.classList.add('hidden'), 500);
                
                const { main, sub } = getPersonalizedGreeting();
                ui.welcomeGreet.textContent = main;
                ui.welcomeSubtext.textContent = sub;
                ui.welcomeGreet.classList.add('fade-in-down');
                ui.welcomeSubtext.classList.add('fade-in-up');
                ui.welcomeScreen.classList.remove('hidden');
                
                setTimeout(() => {
                    ui.welcomeScreen.classList.add('hidden');
                    ui.mainDashboard.classList.remove('hidden');
                    populateFilters('chapter-test');
                    populateFilters('chapter-exp');
                }, 4000);
            } else {
                ui.errorMessage.classList.remove('hidden');
                ui.passwordInput.value = '';
                setTimeout(() => ui.errorMessage.classList.add('hidden'), 2000);
            }
        }

        async function initFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyCjtncOkpemPxuaEoQ6mRD_Sc99YQ-G7ig",
                  authDomain: "tanu-neet-dashboard.firebaseapp.com",
                  projectId: "tanu-neet-dashboard",
                  storageBucket: "tanu-neet-dashboard.firebasestorage.app",
                  messagingSenderId: "911874194562",
                  appId: "1:911874194562:web:fb8b2fbb2d737d52e3c89b",
                  measurementId: "G-CYNCVKV6Y2"
                };

                appId = firebaseConfig.projectId;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid;
                if (!userId) throw new Error("Authentication failed, user ID is not available.");
                
                setupHistoryListeners();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                let userErrorMessage = "Could not connect to the database. Please check your Firebase configuration and refresh.";
                ui.mainDashboard.innerHTML = `<div class="p-8"><p class="text-red-500 text-center">${userErrorMessage}</p></div>`;
            }
        }

        // --- API Interaction ---
        async function fetchApiResponse(url, payload, options = {}) {
            const { timeout = 120000, retries = 3, onRetryMessage } = options;
            
            if (geminiApiKey === "YOUR_API_KEY_HERE") {
                throw new Error("API key is missing. Please add your key from Google AI Studio to the script.");
            }

            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: controller.signal 
                    });
                    
                    clearTimeout(id);
                    
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    lastError = error;
                    if (error.name === 'AbortError') {
                        throw new Error('The request to the AI service timed out. Please try again.');
                    }
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        if(onRetryMessage) onRetryMessage(`AI service is busy, retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw lastError;
                    }
                }
            }
        }

        function safeJsonParse(jsonText) {
            if (typeof jsonText !== 'string') {
                if (typeof jsonText === 'object' && jsonText !== null) return jsonText;
                return null;
            }
            try {
                let cleanedText = jsonText.trim();
                if (cleanedText.startsWith("```json")) {
                    cleanedText = cleanedText.substring(7).trim();
                }
                if (cleanedText.endsWith("```")) {
                    cleanedText = cleanedText.slice(0, -3).trim();
                }
                return JSON.parse(cleanedText);
            } catch (e) {
                return null;
            }
        }

        // --- Feature Handlers ---
        function clearFile() {
            uploadedFileContent = null;
            ui.fileDisplayArea.innerHTML = '';
            ui.fileUploadInput.value = ''; // Reset file input
            ui.clearSearchBtn.classList.toggle('hidden', ui.searchInput.value.trim() === '');
        }

        function handleClearSearch() {
            ui.searchInput.value = '';
            ui.geminiResponseEl.innerHTML = '';
            ui.resultsSection.classList.add('hidden');
            clearFile();
        }

        function handleVoiceSearch() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("Browser doesn't support voice recognition.");
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            ui.micBtn.classList.add('mic-listening');
            const recognitionTimeout = setTimeout(() => recognition.stop(), 6000);
            recognition.onresult = (event) => {
                ui.searchInput.value = event.results[0][0].transcript;
                ui.clearSearchBtn.classList.remove('hidden');
                handleSearch();
            };
            recognition.onend = () => {
                clearTimeout(recognitionTimeout);
                ui.micBtn.classList.remove('mic-listening');
            };
            recognition.onerror = (event) => console.error(`Recognition error: ${event.error}`);
            recognition.start();
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = {
                    name: file.name,
                    mimeType: file.type,
                    data: e.target.result
                };
                displayUploadedFile();
            };
            reader.readAsDataURL(file);
        }

        async function openCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    ui.cameraFeed.srcObject = cameraStream;
                    ui.cameraModal.style.display = 'block';
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: Could not access the camera. Please check permissions.</p>`;
                    ui.resultsSection.classList.remove('hidden');
                }
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            ui.cameraModal.style.display = 'none';
        }

        function snapPhoto() {
            const canvas = ui.cameraCanvas;
            const video = ui.cameraFeed;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            uploadedFileContent = {
                name: `capture-${Date.now()}.jpg`,
                mimeType: 'image/jpeg',
                data: dataUrl
            };
            
            closeCamera();
            displayUploadedFile();
        }

        function displayUploadedFile() {
            ui.fileDisplayArea.innerHTML = `
                <span class="bg-gray-600 text-sm py-1 px-3 rounded-full inline-flex items-center gap-2">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
                    <span>${uploadedFileContent.name}</span>
                </span>`;
            ui.clearSearchBtn.classList.remove('hidden');
        }

        async function handleSearch() {
            const query = ui.searchInput.value.trim();
            if ((!query && !uploadedFileContent) || !userId) return;
            
            ui.searchBtn.disabled = true;
            ui.searchBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;
            ui.resultsSection.classList.remove('hidden');
            ui.geminiResponseEl.innerHTML = '<p>Analyzing with AI...</p>';

            let payload;
            let useJsonResponse = false;

            if (uploadedFileContent) {
                const parts = [
                    { text: query || `Analyze the attached file: ${uploadedFileContent.name}` },
                    { 
                        inlineData: { 
                            mimeType: uploadedFileContent.mimeType, 
                            data: uploadedFileContent.data.split(',')[1]
                        } 
                    }
                ];
                payload = { contents: [{ role: "user", parts }] };
            } else {
                const structuredPrompt = `For the NEET concept "${query}", provide a response as a valid JSON object. The object must have "shortAnswer" (2-3 sentences) and "detailedAnswer". If it involves a formula, include a "derivation" key. If not applicable, set "derivation" to null.`;
                payload = { 
                    contents: [{ role: "user", parts: [{ text: structuredPrompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                useJsonResponse = true;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            try {
                const result = await fetchApiResponse(apiUrl, payload);
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!responseText) throw new Error("Received an empty response from the AI.");
                
                let data;
                if (useJsonResponse) {
                    data = safeJsonParse(responseText);
                }
                
                if (data) {
                    renderStructuredResponse(ui.geminiResponseEl, data, query);
                } else {
                    renderStructuredResponse(ui.geminiResponseEl, { detailedAnswer: responseText }, query);
                }
                
                const historyQuery = uploadedFileContent ? `${query} (file: ${uploadedFileContent.name})` : query;
                const historyData = { type: 'search', query: historyQuery, response: responseText, timestamp: Date.now() };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/searchHistory`), historyData);

            } catch (error) {
                 ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                ui.searchBtn.disabled = false;
                ui.searchBtn.innerHTML = 'Search';
            }
        }
        
        async function handleGenerateStudyPlan() {
            const weeks = ui.studyWeeks.value;
            const subjects = ui.studySubjects.value;
            ui.studyPlanOutput.innerHTML = 'Generating your personalized study plan...';
            const prompt = `Create a detailed, day-by-day study plan for a student for ${weeks} weeks, focusing on: ${subjects || 'all subjects'}. Format it clearly.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            try {
                const result = await fetchApiResponse(apiUrl, payload, { timeout: 90000 });
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                ui.studyPlanOutput.innerHTML = text.replace(/\*/g, '');
            } catch (error) {
                ui.studyPlanOutput.innerHTML = `<p class="text-red-400">Error generating plan: ${error.message}</p>`;
            }
        }
        
        async function handleChapterExplanation() {
            const year = ui.chapterExpYear.value;
            const subject = ui.chapterExpSubject.value;
            const chapter = ui.chapterExpChapter.value;
            const topic = ui.chapterExpTopic.value.trim();
            const query = topic ? `${topic} from the chapter ${chapter}` : `the chapter ${chapter}`;
            ui.chapterExplanationModal.style.display = 'none';
            ui.resultsSection.classList.remove('hidden');
            ui.geminiResponseEl.innerHTML = `<p>Loading explanation for ${query}...</p>`;
            const prompt = `Provide a detailed explanation for the NEET topic: "${query}". If the concept is visual, include a simplified SVG diagram string in the JSON response. The JSON object must have keys: "topic", "explanation", and "svgDiagram" (string, or null).`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            try {
                const result = await fetchApiResponse(apiUrl, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Received an empty response from the AI.");
                renderExplanationWithDiagram(ui.geminiResponseEl, jsonText, query);
                const historyData = { type: 'explanation', query, response: jsonText, timestamp: Date.now() };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/explanationHistory`), historyData);
            } catch (error) {
                 ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }

        // --- Mock Test Logic ---
        async function startFullTest() {
            currentTestType = 'Full Mock Test';
            const paper = prepareTestUI();
            paper.innerHTML = '<p>Generating unique full test... This will take a moment.</p>';
            try {
                const subjects = ['Physics', 'Chemistry', 'Botany', 'Zoology'];
                const questionPromises = subjects.map(subject => generateQuestionsForSubject(subject, 45, paper));
                const questionSets = await Promise.all(questionPromises);
                currentTestQuestions = questionSets.flat();
                displayQuestions(currentTestQuestions);
                startTimer(180);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }

        async function startSubjectTest(subject) {
            currentTestType = `Subject Test: ${subject}`;
            ui.mockTestModal.style.display = 'block';
            const paper = prepareTestUI(true);
            paper.innerHTML = `<p>Generating unique ${subject} test...</p>`;
            try {
                currentTestQuestions = await generateQuestionsForSubject(subject, 45, paper);
                displayQuestions(currentTestQuestions);
                startTimer(45);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }
        
        async function startChapterTest() {
            const year = ui.chapterTestYear.value;
            const subject = ui.chapterTestSubject.value;
            const chapter = ui.chapterTestChapter.value;
            currentTestType = `Chapter Test: ${chapter}`;
            ui.chapterTestModal.style.display = 'none';
            ui.mockTestModal.style.display = 'block';
            const paper = prepareTestUI(true);
            paper.innerHTML = `<p>Generating test for ${chapter}...</p>`;
            try {
                currentTestQuestions = await generateQuestionsForSubject(subject, 20, paper, chapter);
                displayQuestions(currentTestQuestions);
                startTimer(20);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }
        
        async function generateQuestionsForSubject(subject, count, paperElement, chapter = null) {
            const topic = chapter ? `from the chapter "${chapter}"` : `from various chapters`;
            const prompt = `Generate ${count} unique and non-repetitive, high-quality multiple-choice questions for the NEET exam on the subject of ${subject}, focusing on topics ${topic}. It is crucial that every question is distinct from the others. Format as a valid JSON array of objects with keys: "question", "options" (array of 4 strings), "answer" ("A", "B", "C", or "D"), and "subject" ("${subject}").`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const result = await fetchApiResponse(url, payload);
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Received empty question set from AI.");
            return safeJsonParse(jsonText);
        }

        async function handleSubmitTest() {
            clearInterval(timerInterval);
            const timeTakenMs = Date.now() - testStartTime;
            let score = 0, correctCount = 0, incorrectCount = 0, unattemptedCount = 0;
            const userAnswers = [];
            currentTestQuestions.forEach((q, index) => {
                const selected = document.querySelector(`#mock-test-content input[name="q${index}"]:checked`);
                const answer = selected ? selected.value : null;
                userAnswers.push(answer);
                if (answer) {
                    if (answer === q.answer) { score += 4; correctCount++; } 
                    else { score -= 1; incorrectCount++; }
                } else {
                    unattemptedCount++;
                }
            });
            const testResult = {
                timestamp: Date.now(), type: 'test', testName: currentTestType,
                timeTaken: formatTime(timeTakenMs), score, correctCount, incorrectCount, unattemptedCount,
                questions: JSON.stringify(currentTestQuestions), userAnswers: JSON.stringify(userAnswers)
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/testHistory`), testResult);
            } catch(error) {
                console.error("Error saving test result:", error);
            }
            displayResults({ ...testResult, questions: currentTestQuestions, userAnswers });
        }

        // --- UI Rendering & Updates ---
        function renderStructuredResponse(element, data, query) {
            let finalHtml = '';
            if (data.shortAnswer) {
                finalHtml += `<h3 class="text-xl font-bold text-blue-400 mb-2">Quick Summary</h3><div class="bg-gray-700 p-4 rounded-lg text-gray-300">${data.shortAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>`;
            }
            if (data.detailedAnswer) {
                 finalHtml += `<div class="mt-6"><h3 class="text-xl font-bold text-green-400 mb-2">Detailed Explanation</h3><div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.detailedAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div></div>`;
            }
            if (data.derivation) {
                finalHtml += `<div class="mt-6"><h3 class="text-xl font-bold text-yellow-400 mb-2">Derivation</h3><div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.derivation.replace(/\*/g, '').replace(/\n/g, '<br>')}</div></div>`;
            }
            if (finalHtml) {
                 element.innerHTML = finalHtml;
            } else {
                const rawText = (typeof data === 'object') ? JSON.stringify(data, null, 2) : String(data);
                element.innerHTML = `<h2 class="text-2xl font-bold text-cyan-400 mb-4">Explanation for ${query}</h2><pre class="bg-gray-900 p-4 rounded-lg text-gray-300 whitespace-pre-wrap">${rawText.replace(/\*/g, '').replace(/\\n/g, '\n')}</pre>`;
            }
        }

        function renderExplanationWithDiagram(element, responseText, query) {
            try {
                const data = safeJsonParse(responseText);
                const diagramHtml = data.svgDiagram ? `<div class="mt-6"><h3 class="text-xl font-bold text-yellow-400 mb-2">Diagram</h3><div class="bg-white p-4 rounded-lg flex justify-center items-center">${data.svgDiagram}</div></div>` : '';
                element.innerHTML = `<h2 class="text-2xl font-bold text-cyan-400 mb-4">${data.topic}</h2><div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>${diagramHtml}`;
            } catch (error) {
                element.innerHTML = `<h2 class="text-2xl font-bold text-cyan-400 mb-4">Explanation for ${query}</h2><p class="text-sm text-yellow-400 mb-4">(AI response was not structured, showing raw text.)</p><pre class="bg-gray-900 p-4 rounded-lg text-gray-300 whitespace-pre-wrap">${responseText.replace(/\*/g, '').replace(/\\n/g, '\n')}</pre>`;
            }
        }

        function resetFullTestModal() {
            ui.mockTestContent.innerHTML = `<div id="mock-test-instructions"><h2 class="text-2xl font-bold mb-4">NEET Full Mock Test</h2><ul class="list-disc list-inside text-gray-300 space-y-2"><li>180 MCQs.</li><li>+4 for correct, -1 for incorrect.</li><li>Duration: <strong>3 hours</strong>.</li></ul><button id="start-full-test-btn" class="mt-6 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Start Full Test</button></div><div id="mock-test-paper" class="hidden mt-6"></div>`;
            document.getElementById('start-full-test-btn').addEventListener('click', startFullTest);
        }

        function prepareTestUI(isSubjectTest = false) {
            if (isSubjectTest) {
                ui.mockTestContent.innerHTML = '<div id="mock-test-paper"></div>';
            } else {
                ui.mockTestContent.querySelector('#mock-test-instructions')?.classList.add('hidden');
            }
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            paper.classList.remove('hidden');
            return paper;
        }

        function handleTestGenerationError(paperElement, error) {
            paperElement.innerHTML = `<p class="text-red-400">Failed to generate the test: ${error.message}. Please try again.</p>`;
        }

        function displayQuestions(questions) {
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            let questionsHtml = `<div class="sticky top-0 tlearn-bg py-2 z-10 flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${currentTestType}</h2><div id="timer-display" class="text-2xl font-bold tlearn-red-text font-mono"></div></div>`;
            questions.forEach((q, index) => {
                questionsHtml += `<div class="mb-6"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2" id="q-${index}">${q.options.map((opt, i) => `<div><input type="radio" id="q${index}opt${i}" name="q${index}" value="${String.fromCharCode(65 + i)}"><label for="q${index}opt${i}" class="ml-2">${String.fromCharCode(65 + i)}) ${opt}</label></div>`).join('')}</div></div>`;
            });
            questionsHtml += `<button id="submit-test-btn" class="mt-8 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Submit Test</button>`;
            paper.innerHTML = questionsHtml;
            document.getElementById('submit-test-btn').addEventListener('click', handleSubmitTest);
        }

        async function handleAllExplanations(result) {
            const explanationsContainer = document.getElementById('explanations-container');
            explanationsContainer.innerHTML = `<p class="text-center text-yellow-400">Generating explanations for all questions...</p>`;
            const prompt = `For the following MCQs, explain why the correct answer is right. Format as a JSON array of objects, each with "question" and "explanation" keys. Questions: ${JSON.stringify(result.questions)}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            try {
                const apiResult = await fetchApiResponse(apiUrl, payload, { timeout: 180000 });
                const explanations = safeJsonParse(apiResult.candidates?.[0]?.content?.parts?.[0]?.text);
                const explanationMap = new Map(explanations.map(exp => [exp.question, exp.explanation]));
                result.questions.forEach((q, index) => {
                    const questionContainer = document.getElementById(`question-review-${index}`);
                    const explanation = explanationMap.get(q.question);
                    if (questionContainer && explanation) {
                        const explanationDiv = document.createElement('div');
                        explanationDiv.className = 'mt-4 p-3 bg-gray-900 border-l-2 border-blue-500 rounded-r-lg';
                        explanationDiv.innerHTML = `<h4 class="font-semibold text-blue-300">Explanation:</h4><p class="text-gray-300">${explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}</p>`;
                        questionContainer.appendChild(explanationDiv);
                    }
                });
                document.getElementById('explanation-buttons').style.display = 'none';
            } catch (error) {
                explanationsContainer.innerHTML = `<p class="text-red-400">Error generating explanations: ${error.message}</p>`;
            }
        }

        async function handleMistakeExplanations(result) {
            const explanationsContainer = document.getElementById('explanations-container');
            explanationsContainer.innerHTML = `<p class="text-center text-yellow-400">Generating explanations for your mistakes...</p>`;
            const incorrectQuestions = result.questions.filter((q, i) => result.userAnswers[i] && result.userAnswers[i] !== q.answer);
            const prompt = `For my mistakes in the following MCQs, explain why my answer was wrong and the correct one is right. Format as a JSON array of objects with "question" and "explanation" keys. Mistakes: ${JSON.stringify(incorrectQuestions)}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            try {
                const apiResult = await fetchApiResponse(apiUrl, payload, { timeout: 120000 });
                const explanations = safeJsonParse(apiResult.candidates?.[0]?.content?.parts?.[0]?.text);
                const explanationMap = new Map(explanations.map(exp => [exp.question, exp.explanation]));
                result.questions.forEach((q, index) => {
                    if (result.userAnswers[index] && result.userAnswers[index] !== q.answer) {
                        const questionContainer = document.getElementById(`question-review-${index}`);
                        const explanation = explanationMap.get(q.question);
                        if (questionContainer && explanation) {
                            const explanationDiv = document.createElement('div');
                            explanationDiv.className = 'mt-4 p-3 bg-gray-900 border-l-2 border-yellow-500 rounded-r-lg';
                            explanationDiv.innerHTML = `<h4 class="font-semibold text-yellow-300">Explanation:</h4><p class="text-gray-300">${explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}</p>`;
                            questionContainer.appendChild(explanationDiv);
                        }
                    }
                });
                document.getElementById('explanation-buttons').style.display = 'none';
            } catch (error) {
                explanationsContainer.innerHTML = `<p class="text-red-400">Error generating explanations: ${error.message}</p>`;
            }
        }

        function displayResults(result) {
            const questions = safeJsonParse(result.questions);
            const userAnswers = safeJsonParse(result.userAnswers);
            let buttonsHtml = `<div id="explanation-buttons" class="space-y-4"><button id="explain-all-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md">âœ¨ Generate Explanations for All</button>`;
            if (result.incorrectCount > 0) {
                buttonsHtml += `<button id="explain-mistakes-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 px-6 rounded-md">ðŸ¤” Explain My Mistakes</button>`;
            }
            buttonsHtml += `</div>`;
            let resultsHtml = `<h2 class="text-3xl font-bold mb-4">${result.testName || result.type} - Results</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-8"><div class="bg-gray-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.score}</p><p>Score</p></div><div class="bg-green-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.correctCount}</p><p>Correct</p></div><div class="bg-red-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.incorrectCount}</p><p>Incorrect</p></div><div class="bg-gray-600 p-4 rounded-lg"><p class="text-2xl font-bold">${result.unattemptedCount}</p><p>Unattempted</p></div></div><p class="text-center text-lg mb-6">Time Taken: <strong>${result.timeTaken}</strong></p>${buttonsHtml}<div id="explanations-container" class="mt-4"></div><h3 class="text-2xl font-bold mb-4 mt-6">Review Answers</h3>`;
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                let optionsHtml = q.options.map((opt, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    let labelClass = (optionLetter === q.answer) ? 'correct-answer' : (optionLetter === userAnswer) ? 'incorrect-answer' : '';
                    return `<div><label class="ml-2 ${labelClass}">${optionLetter}) ${opt}</label></div>`;
                }).join('');
                resultsHtml += `<div id="question-review-${index}" class="mb-6 p-4 bg-gray-800 rounded-lg"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2">${optionsHtml}</div></div>`;
            });
            ui.mockTestContent.innerHTML = resultsHtml;
            document.getElementById('explain-all-btn').addEventListener('click', () => handleAllExplanations({ ...result, questions, userAnswers }));
            if (result.incorrectCount > 0) {
                document.getElementById('explain-mistakes-btn').addEventListener('click', () => handleMistakeExplanations({ ...result, questions, userAnswers }));
            }
        }
        
        function populateFilters(type) {
            const camelCaseType = type.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            const yearDropdown = ui[`${camelCaseType}Year`];
            const subjectDropdown = ui[`${camelCaseType}Subject`];
            const chapterDropdown = ui[`${camelCaseType}Chapter`];
            if(!yearDropdown || !subjectDropdown || !chapterDropdown) return;
            const year = yearDropdown.value;
            const currentSubject = subjectDropdown.value;
            subjectDropdown.innerHTML = '';
            Object.keys(syllabus[year]).forEach(subject => {
                const option = document.createElement('option');
                option.value = subject; option.textContent = subject;
                if (subject === currentSubject) option.selected = true;
                subjectDropdown.appendChild(option);
            });
            const selectedSubject = subjectDropdown.value || Object.keys(syllabus[year])[0];
            chapterDropdown.innerHTML = '';
            syllabus[year][selectedSubject].forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter; option.textContent = chapter;
                chapterDropdown.appendChild(option);
            });
        }
        
        function setupHistoryListeners() {
            if (!userId) return;
            if (unsubscribeTestHistory) unsubscribeTestHistory();
            if (unsubscribeSearchHistory) unsubscribeSearchHistory();
            if (unsubscribeExplanationHistory) unsubscribeExplanationHistory();
            const testHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/testHistory`);
            const searchHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/searchHistory`);
            const explanationHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/explanationHistory`);
            const updateCombinedHistory = () => {
                const tests = testHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const searches = searchHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const explanations = explanationHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                combinedHistory = [...tests, ...searches, ...explanations].sort((a, b) => b.timestamp - a.timestamp);
                renderHistory();
            };
            let testHistory = { docs: [] }, searchHistory = { docs: [] }, explanationHistory = { docs: [] };
            unsubscribeTestHistory = onSnapshot(query(testHistoryCol, orderBy("timestamp", "desc")), (snapshot) => { testHistory = snapshot; updateCombinedHistory(); });
            unsubscribeSearchHistory = onSnapshot(query(searchHistoryCol, orderBy("timestamp", "desc")), (snapshot) => { searchHistory = snapshot; updateCombinedHistory(); });
            unsubscribeExplanationHistory = onSnapshot(query(explanationHistoryCol, orderBy("timestamp", "desc")), (snapshot) => { explanationHistory = snapshot; updateCombinedHistory(); });
        }

        function renderHistory() {
            ui.historyContent.innerHTML = '';
            if (!combinedHistory || combinedHistory.length === 0) {
                 ui.historyContent.innerHTML = '<p class="text-gray-400">No history yet. Take a test or search for a concept to get started!</p>';
                 return;
            }
            const groupedByDate = combinedHistory.reduce((acc, result) => {
                const date = new Date(result.timestamp).toLocaleDateString('en-CA'); 
                if (!acc[date]) acc[date] = [];
                acc[date].push(result);
                return acc;
            }, {});
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
            sortedDates.forEach(dateStr => {
                const dateHeading = document.createElement('h3');
                dateHeading.className = 'text-lg font-semibold mt-4 mb-2 text-gray-400';
                const today = new Date().toLocaleDateString('en-CA');
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (dateStr === today) dateHeading.textContent = 'Today';
                else if (dateStr === yesterday.toLocaleDateString('en-CA')) dateHeading.textContent = 'Yesterday';
                else dateHeading.textContent = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                ui.historyContent.appendChild(dateHeading);
                groupedByDate[dateStr].forEach(item => {
                    const record = document.createElement('div');
                    record.className = 'p-4 bg-gray-700 rounded-md mb-3 flex justify-between items-center';
                    let itemHtml = '';
                    if (item.type === 'test') {
                        itemHtml = `<div><p class="font-bold">${item.testName}</p><p>Score: ${item.score}</p></div>`;
                    } else if (item.type === 'search' || item.type === 'explanation') {
                        itemHtml = `<div><p class="font-bold">${item.type === 'search' ? 'Searched' : 'Explained'}:</p><p>${item.query}</p></div>`;
                    }
                    record.innerHTML = `${itemHtml}<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">View</button>`;
                    record.querySelector('button').addEventListener('click', () => {
                        ui.historyModal.style.display = 'none';
                        if (item.type === 'test') {
                            ui.mockTestModal.style.display = 'block';
                            displayResults(item);
                        } else {
                            ui.resultsSection.classList.remove('hidden');
                            const responseData = safeJsonParse(item.response);
                            if (responseData && typeof responseData === 'object') {
                                if (item.type === 'explanation') renderExplanationWithDiagram(ui.geminiResponseEl, item.response, item.query);
                                else renderStructuredResponse(ui.geminiResponseEl, responseData, item.query);
                            } else {
                                renderStructuredResponse(ui.geminiResponseEl, { detailedAnswer: item.response }, item.query);
                            }
                        }
                    });
                    ui.historyContent.appendChild(record);
                });
            });
        }

        // --- Utility Functions ---
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}m ${seconds}s`;
        }
        
        function startTimer(durationInMinutes) {
            clearInterval(timerInterval);
            testStartTime = Date.now();
            const endTime = testStartTime + durationInMinutes * 60 * 1000;
            timerInterval = setInterval(() => {
                const distance = endTime - Date.now();
                const timerDisplay = document.getElementById('timer-display');
                if (distance < 0) {
                    clearInterval(timerInterval);
                    if (timerDisplay) timerDisplay.innerHTML = "Time's Up!";
                    document.getElementById('submit-test-btn')?.click();
                    return;
                }
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if (timerDisplay) timerDisplay.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- Initializer ---
        setupEventListeners();

    </script>
</body>
</html>
