<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLEARN - NEET Preparation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tlearn-bg {
            background-color: #141414;
        }
        .tlearn-red {
            background-color: #E50914;
        }
        .tlearn-red-text {
            color: #E50914;
        }
        .search-bar-container {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #lock-screen {
            background: url('https://placehold.co/1920x1080/000000/FFFFFF?text=TLEARN') no-repeat center center fixed;
            background-size: cover;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1f1f1f;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        .correct-answer {
            background-color: rgba(4, 120, 87, 0.3);
            padding: 2px 4px;
            border-radius: 4px;
        }
        .incorrect-answer {
            background-color: rgba(224, 62, 62, 0.3);
            padding: 2px 4px;
            border-radius: 4px;
            text-decoration: line-through;
        }
    </style>
</head>
<body class="tlearn-bg text-white">

    <!-- Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black">
        <div class="bg-black bg-opacity-75 p-8 rounded-lg text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-4">Tanu's NEET Prep</h1>
            <p class="text-gray-400 mb-6">Enter Passcode</p>
            <input type="password" id="password-input" class="w-full bg-gray-800 text-white p-3 rounded-md text-center tracking-widest text-2xl" maxlength="8">
            <p id="error-message" class="text-red-500 mt-4 hidden">Incorrect Passcode</p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-black hidden">
        <div class="text-center p-4">
            <h1 id="welcome-greet" class="text-4xl md:text-6xl font-bold animate-pulse"></h1>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden">
        <header class="p-4 flex justify-between items-center flex-wrap">
             <h1 class="text-3xl font-bold tlearn-red-text"><span class="text-4xl">T</span>LEARN</h1>
             <div id="user-info" class="text-xs text-gray-500"></div>
            <div class="flex items-center space-x-2 md:space-x-4 mt-2 md:mt-0">
                <button id="study-plan-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm md:text-base">✨ Create Study Plan</button>
                <button id="mock-test-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm md:text-base">Full Mock Test</button>
                <button id="subject-test-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm md:text-base">Subject Test</button>
                <button id="history-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md text-sm md:text-base">History</button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <!-- Search Section -->
            <div class="search-bar-container p-6 md:p-10 rounded-lg text-center mb-8">
                <h2 class="text-3xl md:text-5xl font-bold mb-6">What concept are you exploring today?</h2>
                <div class="flex flex-col md:flex-row justify-center items-center max-w-4xl mx-auto">
                    <input type="text" id="search-input" class="w-full md:w-3/4 bg-gray-800 text-white p-4 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="e.g., 'Derive the formula for kinetic energy'">
                    <button id="search-btn" class="w-full md:w-auto mt-4 md:mt-0 md:ml-4 tlearn-red hover:bg-red-700 text-white font-bold py-4 px-8 rounded-md text-lg">Search</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div id="gemini-response" class="p-4 bg-gray-800 rounded-md"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="study-plan-modal" class="modal">
        <div class="modal-content">
            <span id="close-study-plan" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">✨ AI Study Plan Generator</h2>
            <div class="space-y-4">
                <div>
                    <label for="study-weeks" class="block text-sm font-medium text-gray-300">Number of Weeks to Study:</label>
                    <input type="number" id="study-weeks" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" value="8">
                </div>
                <div>
                    <label for="study-subjects" class="block text-sm font-medium text-gray-300">Subjects to Focus On (comma-separated):</label>
                    <input type="text" id="study-subjects" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" placeholder="e.g., Physics, Organic Chemistry">
                </div>
                <button id="generate-plan-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md">Generate Plan</button>
            </div>
            <div id="study-plan-output" class="mt-6 p-4 bg-gray-900 rounded-lg min-h-[200px] text-gray-300 whitespace-pre-wrap"></div>
        </div>
    </div>

    <div id="mock-test-modal" class="modal">
        <div class="modal-content">
            <span id="close-mock-test" class="close">&times;</span>
            <div id="mock-test-content"></div>
        </div>
    </div>

    <div id="subject-test-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span id="close-subject-test" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">Choose a Subject</h2>
            <div id="subject-choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button class="subject-choice-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Physics">Physics</button>
                <button class="subject-choice-btn bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Chemistry">Chemistry</button>
                <button class="subject-choice-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Botany">Botany</button>
                <button class="subject-choice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Zoology">Zoology</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="close-history" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">History</h2>
            <div id="history-content">
                <h3 class="text-xl font-semibold mb-2">Search History</h3>
                <ul id="search-history-list" class="list-disc list-inside text-gray-300"></ul>
                <h3 class="text-xl font-semibold mt-6 mb-2">Mock Test Tracker</h3>
                <div id="mock-test-tracker"></div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Application State ---
        let db, auth, userId, appId;
        let unsubscribeMockTests, unsubscribeSearchHistory;
        let currentTestQuestions = [];
        let mockTestHistory = [];
        let timerInterval = null;
        let testStartTime = 0;
        let currentTestType = '';

        // --- IMPORTANT: API KEY MANAGEMENT ---
        // The user's Gemini API key is placed here.
        const geminiApiKey = "AIzaSyD_Dxv-dgdv8PYp97-F74dM0day1FEA8Do"; 

        // --- DOM Elements Cache ---
        const ui = {
            passwordInput: document.getElementById('password-input'),
            lockScreen: document.getElementById('lock-screen'),
            welcomeScreen: document.getElementById('welcome-screen'),
            mainDashboard: document.getElementById('main-dashboard'),
            errorMessage: document.getElementById('error-message'),
            welcomeGreet: document.getElementById('welcome-greet'),
            searchBtn: document.getElementById('search-btn'),
            searchInput: document.getElementById('search-input'),
            resultsSection: document.getElementById('results-section'),
            geminiResponseEl: document.getElementById('gemini-response'),
            mockTestBtn: document.getElementById('mock-test-btn'),
            subjectTestBtn: document.getElementById('subject-test-btn'),
            historyBtn: document.getElementById('history-btn'),
            studyPlanBtn: document.getElementById('study-plan-btn'),
            mockTestModal: document.getElementById('mock-test-modal'),
            subjectTestModal: document.getElementById('subject-test-modal'),
            historyModal: document.getElementById('history-modal'),
            studyPlanModal: document.getElementById('study-plan-modal'),
            closeMockTest: document.getElementById('close-mock-test'),
            closeSubjectTest: document.getElementById('close-subject-test'),
            closeHistory: document.getElementById('close-history'),
            closeStudyPlan: document.getElementById('close-study-plan'),
            mockTestContent: document.getElementById('mock-test-content'),
            subjectChoiceContainer: document.getElementById('subject-choice-container'),
            searchHistoryList: document.getElementById('search-history-list'),
            mockTestTracker: document.getElementById('mock-test-tracker'),
            userInfoEl: document.getElementById('user-info'),
            generatePlanBtn: document.getElementById('generate-plan-btn'),
            studyPlanOutput: document.getElementById('study-plan-output'),
            studyWeeks: document.getElementById('study-weeks'),
            studySubjects: document.getElementById('study-subjects'),
        };

        const greetings = [
            "Why did the neuron break up with the axon? It felt there was no connection! Let's make some connections in biology today!",
            "What do you call a biologist's favorite song? 'Sweet Home Alabama'... because it's full of relatives!",
            "Why are chemists so good at solving problems? They have all the solutions! Time to find some for NEET.",
            "If you're not part of the solution, you're part of the precipitate. Let's be the solution today!",
            "Are you made of copper and tellurium? Because you're Cu-Te! Now let's get serious about studying.",
            "Welcome, future doctor! Remember, the Krebs cycle is like a great story - it's all about the drama of electrons."
        ];

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            ui.passwordInput.addEventListener('input', (e) => {
                if (e.target.value.length === 8) handleLogin(e.target.value);
            });
            ui.searchBtn.addEventListener('click', handleSearch);
            ui.mockTestBtn.addEventListener('click', () => {
                resetFullTestModal();
                ui.mockTestModal.style.display = 'block';
            });
            ui.subjectTestBtn.addEventListener('click', () => ui.subjectTestModal.style.display = 'block');
            ui.subjectChoiceContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('subject-choice-btn')) {
                    const subject = e.target.dataset.subject;
                    ui.subjectTestModal.style.display = 'none';
                    startSubjectTest(subject);
                }
            });
            ui.historyBtn.addEventListener('click', () => ui.historyModal.style.display = 'block');
            ui.studyPlanBtn.addEventListener('click', () => ui.studyPlanModal.style.display = 'block');
            ui.generatePlanBtn.addEventListener('click', handleGenerateStudyPlan);
            
            // Modal close buttons
            ui.closeMockTest.addEventListener('click', () => ui.mockTestModal.style.display = 'none');
            ui.closeSubjectTest.addEventListener('click', () => ui.subjectTestModal.style.display = 'none');
            ui.closeHistory.addEventListener('click', () => ui.historyModal.style.display = 'none');
            ui.closeStudyPlan.addEventListener('click', () => ui.studyPlanModal.style.display = 'none');
            
            // Close modal on outside click
            window.addEventListener('click', (event) => {
                if (event.target == ui.mockTestModal) ui.mockTestModal.style.display = 'none';
                if (event.target == ui.historyModal) ui.historyModal.style.display = 'none';
                if (event.target == ui.subjectTestModal) ui.subjectTestModal.style.display = 'none';
                if (event.target == ui.studyPlanModal) ui.studyPlanModal.style.display = 'none';
            });
        }

        // --- Core Application Logic ---

        async function handleLogin(password) {
            if (password === '02102008') {
                await initFirebase(); 
                ui.lockScreen.classList.add('hidden');
                const randomGreet = greetings[Math.floor(Math.random() * greetings.length)];
                ui.welcomeGreet.textContent = randomGreet;
                ui.welcomeScreen.classList.remove('hidden');
                setTimeout(() => {
                    ui.welcomeScreen.classList.add('hidden');
                    ui.mainDashboard.classList.remove('hidden');
                }, 5000); 
            } else {
                ui.errorMessage.classList.remove('hidden');
                ui.passwordInput.value = '';
                setTimeout(() => ui.errorMessage.classList.add('hidden'), 2000);
            }
        }

        async function initFirebase() {
            try {
                // This configuration is for client-side initialization
                const firebaseConfig = {
                  apiKey: "AIzaSyCjtncOkpemPxuaEoQ6mRD_Sc99YQ-G7ig",
                  authDomain: "tanu-neet-dashboard.firebaseapp.com",
                  projectId: "tanu-neet-dashboard",
                  storageBucket: "tanu-neet-dashboard.firebasestorage.app",
                  messagingSenderId: "911874194562",
                  appId: "1:911874194562:web:fb8b2fbb2d737d52e3c89b",
                  measurementId: "G-CYNCVKV6Y2"
                };

                appId = firebaseConfig.projectId;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid;
                if (!userId) throw new Error("Authentication failed, user ID is not available.");
                
                ui.userInfoEl.textContent = `UserID: ${userId}`;
                setupHistoryListeners();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                let userErrorMessage = "Could not connect to the database. Please check your Firebase configuration and refresh.";
                ui.mainDashboard.innerHTML = `<div class="p-8"><p class="text-red-500 text-center">${userErrorMessage}</p></div>`;
            }
        }

        // --- API Interaction ---

        async function fetchApiResponse(url, payload, options = {}) {
            const { timeout = 60000, retries = 3, onRetryMessage } = options;
            
            if (geminiApiKey === "YOUR_GEMINI_API_KEY") {
                throw new Error("Gemini API key is missing. Please add your key to the script to use AI features.");
            }

            for (let i = 0; i < retries; i++) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: controller.signal 
                    });
                    
                    clearTimeout(id);
                    
                    if (response.status === 503) {
                        if (i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000; // Exponential backoff
                            if(onRetryMessage) onRetryMessage(`AI service is busy, retrying in ${delay / 1000}s... (Attempt ${i + 2})`);
                            await new Promise(res => setTimeout(res, delay));
                            continue; // Go to the next iteration to retry
                        } else {
                            throw new Error("API request failed: The AI service is currently unavailable after multiple retries (Error 503).");
                        }
                    }
                    
                    if (response.status === 400) {
                        throw new Error("API request failed with status 400 (Bad Request). This is often due to an invalid API key or a problem with the AI model's input.");
                    }
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return await response.json(); // Success
                } catch (error) {
                    clearTimeout(id);
                    if (error.name === 'AbortError') {
                        throw new Error('The request to the AI service timed out. Please try again.');
                    }
                    // If it's the last retry and it still fails, or it's not a retryable error
                    if (i === retries - 1 || response.status !== 503) {
                        throw error;
                    }
                }
            }
        }

        function safeJsonParse(jsonText) {
            if (typeof jsonText !== 'string') {
                if (typeof jsonText === 'object' && jsonText !== null) return jsonText;
                throw new Error("Invalid input to safeJsonParse: not a string.");
            }
            try {
                let cleanedText = jsonText.trim();
                if (cleanedText.startsWith("```json")) {
                    cleanedText = cleanedText.substring(7);
                }
                if (cleanedText.endsWith("```")) {
                    cleanedText = cleanedText.slice(0, -3);
                }
                const startIndex = cleanedText.indexOf('{');
                const endIndex = cleanedText.lastIndexOf('}');
                if (startIndex !== -1 && endIndex !== -1) {
                    cleanedText = cleanedText.substring(startIndex, endIndex + 1);
                }
                return JSON.parse(cleanedText);
            } catch (e) {
                console.error("JSON Parsing Error:", e, "Raw text:", jsonText);
                throw new Error("The AI model returned an invalid JSON format. Please try again.");
            }
        }

        // --- Feature Handlers ---

        async function handleSearch() {
            const query = ui.searchInput.value.trim();
            if (!query || !userId) return;
            
            ui.searchBtn.disabled = true;
            ui.searchBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;
            ui.resultsSection.classList.remove('hidden');
            ui.geminiResponseEl.innerHTML = '<p>Loading explanation from AI...</p>';
            
            try {
                const searchHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/searchHistory`);
                await addDoc(searchHistoryCol, { query, timestamp: Date.now() });
            } catch (error) {
                console.error("Error saving search history:", error);
            }

            const structuredPrompt = `For the NEET concept "${query}", provide a response as a valid JSON object. The object must have "shortAnswer" (2-3 sentences) and "detailedAnswer". If the concept is from Physics or Chemistry and involves a formula or principle that can be derived, also include a "derivation" key with the step-by-step derivation. If no derivation is applicable, set "derivation" to null.`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: structuredPrompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            try {
                const result = await fetchApiResponse(apiUrl, payload, { 
                    onRetryMessage: (msg) => ui.geminiResponseEl.innerHTML = `<p>${msg}</p>` 
                });
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Received an empty response from the AI service.");
                
                const data = safeJsonParse(jsonText);
                renderStructuredResponse(ui.geminiResponseEl, data, query);

            } catch (error) {
                 ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                ui.searchBtn.disabled = false;
                ui.searchBtn.innerHTML = 'Search';
            }
        }
        
        async function handleGenerateStudyPlan() {
            const weeks = ui.studyWeeks.value;
            const subjects = ui.studySubjects.value;
            ui.studyPlanOutput.innerHTML = 'Generating your personalized study plan...';

            const prompt = `Create a detailed, day-by-day study plan for a NEET student for ${weeks} weeks, focusing on: ${subjects || 'all subjects'}. Format it clearly.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const result = await fetchApiResponse(apiUrl, payload, { 
                    timeout: 90000,
                    onRetryMessage: (msg) => ui.studyPlanOutput.innerHTML = `<p>${msg}</p>`
                });
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                ui.studyPlanOutput.innerHTML = text.replace(/\*/g, '');
            } catch (error) {
                ui.studyPlanOutput.innerHTML = `<p class="text-red-400">Error generating plan: ${error.message}</p>`;
            }
        }

        // --- Mock Test Logic ---

        async function startFullTest() {
            currentTestType = 'Full Mock Test';
            const paper = prepareTestUI();
            paper.innerHTML = '<p>Generating unique full test... This will take a moment.</p>';
            
            try {
                const subjects = ['Physics', 'Chemistry', 'Botany', 'Zoology'];
                const questionPromises = subjects.map(subject => generateQuestionsForSubject(subject, 45, paper));
                const questionSets = await Promise.all(questionPromises);
                currentTestQuestions = questionSets.flat();
                displayQuestions(currentTestQuestions);
                startTimer(180);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }

        async function startSubjectTest(subject) {
            currentTestType = `Subject Test: ${subject}`;
            ui.mockTestModal.style.display = 'block';
            const paper = prepareTestUI(true);
            paper.innerHTML = `<p>Generating unique ${subject} test...</p>`;
            try {
                currentTestQuestions = await generateQuestionsForSubject(subject, 45, paper);
                displayQuestions(currentTestQuestions);
                startTimer(45);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }

        async function generateQuestionsForSubject(subject, count, paperElement) {
            const prompt = `Generate ${count} unique, high-quality multiple-choice questions for NEET exam preparation on the subject of ${subject}. Format as a valid JSON array of objects, with keys: "question", "options" (array of 4 strings), "answer" (string "A", "B", "C", or "D"), and "subject" ("${subject}").`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const result = await fetchApiResponse(url, payload, { 
                onRetryMessage: (msg) => paperElement.innerHTML = `<p>${msg}</p>` 
            });
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Received empty question set from AI.");
            return safeJsonParse(jsonText);
        }

        async function handleSubmitTest() {
            clearInterval(timerInterval);
            const timeTakenMs = Date.now() - testStartTime;
            let score = 0, correctCount = 0, incorrectCount = 0, unattemptedCount = 0;
            const userAnswers = [];

            currentTestQuestions.forEach((q, index) => {
                const selected = document.querySelector(`#mock-test-content input[name="q${index}"]:checked`);
                const answer = selected ? selected.value : null;
                userAnswers.push(answer);
                if (answer) {
                    if (answer === q.answer) { score += 4; correctCount++; } 
                    else { score -= 1; incorrectCount++; }
                } else {
                    unattemptedCount++;
                }
            });

            const testResult = {
                timestamp: Date.now(),
                type: currentTestType,
                timeTaken: formatTime(timeTakenMs),
                score, correctCount, incorrectCount, unattemptedCount,
                questions: JSON.stringify(currentTestQuestions), 
                userAnswers: JSON.stringify(userAnswers)
            };
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/mockTestHistory`), testResult);
            } catch(error) {
                console.error("Error saving mock test result:", error);
            }

            displayResults({ ...testResult, questions: currentTestQuestions, userAnswers });
        }

        // --- UI Rendering & Updates ---

        function renderStructuredResponse(element, data, query) {
            if (!data || !data.shortAnswer || !data.detailedAnswer) {
                element.innerHTML = `<p class="text-yellow-400">The response from the model was not in the expected format. Please try again.</p>`;
                return;
            }
            const derivationHtml = data.derivation ? `
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">Derivation</h3>
                    <div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.derivation.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                </div>` : '';
            element.innerHTML = `
                <h3 class="text-xl font-bold text-blue-400 mb-2">Quick Summary</h3>
                <div class="bg-gray-700 p-4 rounded-lg text-gray-300">${data.shortAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-green-400 mb-2">Detailed Explanation</h3>
                    <div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.detailedAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                </div>
                ${derivationHtml}`;
        }

        function resetFullTestModal() {
            ui.mockTestContent.innerHTML = `
                <div id="mock-test-instructions">
                    <h2 class="text-2xl font-bold mb-4">NEET Full Mock Test</h2>
                    <ul class="list-disc list-inside text-gray-300 space-y-2">
                        <li>180 multiple-choice questions.</li>
                        <li>+4 for correct, -1 for incorrect.</li>
                        <li>Duration: <strong>3 hours</strong>.</li>
                    </ul>
                    <button id="start-full-test-btn" class="mt-6 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Start Full Test</button>
                </div>
                <div id="mock-test-paper" class="hidden mt-6"></div>`;
            document.getElementById('start-full-test-btn').addEventListener('click', startFullTest);
        }

        function prepareTestUI(isSubjectTest = false) {
            if (isSubjectTest) {
                ui.mockTestContent.innerHTML = '<div id="mock-test-paper"></div>';
            } else {
                const instructions = ui.mockTestContent.querySelector('#mock-test-instructions');
                if (instructions) instructions.classList.add('hidden');
            }
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            paper.classList.remove('hidden');
            return paper;
        }

        function handleTestGenerationError(paperElement, error) {
            let errorMessage = `Failed to generate the test: ${error.message}. Please try again.`;
            paperElement.innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
        }

        function displayQuestions(questions) {
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            let questionsHtml = `<div class="sticky top-0 tlearn-bg py-2 z-10 flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">${currentTestType}</h2>
                                    <div id="timer-display" class="text-2xl font-bold tlearn-red-text font-mono"></div>
                                </div>`;
            questions.forEach((q, index) => {
                questionsHtml += `<div class="mb-6"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2" id="q-${index}">
                    ${q.options.map((opt, i) => `<div><input type="radio" id="q${index}opt${i}" name="q${index}" value="${String.fromCharCode(65 + i)}"><label for="q${index}opt${i}" class="ml-2">${String.fromCharCode(65 + i)}) ${opt}</label></div>`).join('')}
                </div></div>`;
            });
            questionsHtml += `<button id="submit-test-btn" class="mt-8 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Submit Test</button>`;
            paper.innerHTML = questionsHtml;
            document.getElementById('submit-test-btn').addEventListener('click', handleSubmitTest);
        }

        function displayResults(result) {
            const questions = safeJsonParse(result.questions);
            const userAnswers = safeJsonParse(result.userAnswers);
            let resultsHtml = `<h2 class="text-3xl font-bold mb-4">${result.type} - Results</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-8">
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.score}</p><p>Score</p></div>
                    <div class="bg-green-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.correctCount}</p><p>Correct</p></div>
                    <div class="bg-red-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.incorrectCount}</p><p>Incorrect</p></div>
                    <div class="bg-gray-600 p-4 rounded-lg"><p class="text-2xl font-bold">${result.unattemptedCount}</p><p>Unattempted</p></div>
                </div>
                <p class="text-center text-lg mb-6">Time Taken: <strong>${result.timeTaken}</strong></p>
                <h3 class="text-2xl font-bold mb-4">Review Answers</h3>`;
            
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                let optionsHtml = q.options.map((opt, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    let labelClass = '';
                    if (optionLetter === q.answer) labelClass = 'correct-answer';
                    else if (optionLetter === userAnswer) labelClass = 'incorrect-answer';
                    return `<div><label class="ml-2 ${labelClass}">${optionLetter}) ${opt}</label></div>`;
                }).join('');
                resultsHtml += `<div class="mb-6 p-4 bg-gray-800 rounded-lg"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2">${optionsHtml}</div></div>`;
            });
            ui.mockTestContent.innerHTML = resultsHtml;
        }
        
        function setupHistoryListeners() {
            if (!userId) return;
            const mockTestCol = collection(db, `artifacts/${appId}/users/${userId}/mockTestHistory`);
            unsubscribeMockTests = onSnapshot(query(mockTestCol), (snapshot) => {
                mockTestHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory();
            });
            const searchHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/searchHistory`);
            unsubscribeSearchHistory = onSnapshot(query(searchHistoryCol), (snapshot) => {
                ui.searchHistoryList.innerHTML = '';
                const searches = snapshot.docs.map(doc => doc.data()).sort((a,b) => b.timestamp - a.timestamp); 
                searches.forEach(search => {
                    const li = document.createElement('li');
                    li.textContent = search.query;
                    ui.searchHistoryList.appendChild(li);
                });
            });
        }

        function renderHistory() {
            ui.mockTestTracker.innerHTML = '';
            if (!mockTestHistory || mockTestHistory.length === 0) {
                 ui.mockTestTracker.innerHTML = '<p class="text-gray-400">No mock tests taken yet.</p>';
                 return;
            }
            mockTestHistory.sort((a,b) => b.timestamp - a.timestamp).forEach(result => {
                const record = document.createElement('div');
                record.className = 'p-4 bg-gray-700 rounded-md mb-3 flex justify-between items-center';
                record.innerHTML = `<div><p class="font-bold">${result.type}</p><p>Score: ${result.score}</p></div>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">View</button>`;
                record.querySelector('button').addEventListener('click', () => {
                    ui.historyModal.style.display = 'none';
                    ui.mockTestModal.style.display = 'block';
                    displayResults(result);
                });
                ui.mockTestTracker.appendChild(record);
            });
        }

        // --- Utility Functions ---
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}m ${seconds}s`;
        }
        
        function startTimer(durationInMinutes) {
            clearInterval(timerInterval);
            testStartTime = Date.now();
            const endTime = testStartTime + durationInMinutes * 60 * 1000;
            timerInterval = setInterval(() => {
                const distance = endTime - Date.now();
                const timerDisplay = document.getElementById('timer-display');
                if (distance < 0) {
                    clearInterval(timerInterval);
                    if (timerDisplay) timerDisplay.innerHTML = "Time's Up!";
                    document.getElementById('submit-test-btn')?.click();
                    return;
                }
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if (timerDisplay) timerDisplay.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- Initializer ---
        setupEventListeners();

    </script>
</body>
</html>
