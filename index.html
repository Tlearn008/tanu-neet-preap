<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLEARN - NEET Preparation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tlearn-bg {
            background-color: #0d0d0d; /* Darker background for more contrast */
        }
        .tlearn-red {
            background-color: #E50914;
        }
        .tlearn-red-text {
            color: #E50914;
        }
        
        /* --- Lock Screen Styles --- */
        #lock-screen {
            background-color: #000;
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        .aurora-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            filter: blur(100px) saturate(150%);
        }

        .aurora-element {
            position: absolute;
            border-radius: 50%;
            animation: move 20s infinite alternate;
        }

        .aurora-element:nth-child(1) {
            width: 50vw; height: 50vw; max-width: 500px; max-height: 500px;
            background: radial-gradient(circle, rgba(229,9,20,0.5) 0%, rgba(229,9,20,0) 70%);
            top: -20%; left: -10%; animation-duration: 18s;
        }
        .aurora-element:nth-child(2) {
            width: 60vw; height: 60vw; max-width: 600px; max-height: 600px;
            background: radial-gradient(circle, rgba(48,43,99,0.5) 0%, rgba(48,43,99,0) 70%);
            bottom: -30%; right: -20%; animation-duration: 25s;
        }
        .aurora-element:nth-child(3) {
            width: 40vw; height: 40vw; max-width: 400px; max-height: 400px;
            background: radial-gradient(circle, rgba(0, 255, 159, 0.3) 0%, rgba(36,36,62,0) 70%);
            top: 10%; right: 10%; animation-duration: 22s;
        }

        @keyframes move {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(100px, 50px) rotate(45deg); }
        }
        
        .glassmorphism-box {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        #password-input:focus {
            box-shadow: 0 0 15px rgba(229, 9, 20, 0.7);
            border-color: #E50914;
        }

        /* --- Welcome Screen Animations --- */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-down { animation: fadeInDown 1.5s ease-out forwards; }
        .fade-in-up { animation: fadeInUp 1.5s ease-out 0.5s forwards; opacity: 0; }
        
        /* --- Modal Styles --- */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1f1f1f; margin: 5% auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 900px;
            border-radius: 10px; max-height: 90vh; overflow-y: auto;
        }
        .close {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close:hover, .close:focus {
            color: white; text-decoration: none; cursor: pointer;
        }
        .correct-answer {
            background-color: rgba(4, 120, 87, 0.3); padding: 2px 4px; border-radius: 4px;
        }
        .incorrect-answer {
            background-color: rgba(224, 62, 62, 0.3); padding: 2px 4px; border-radius: 4px; text-decoration: line-through;
        }
        select {
            background-color: #2d3748; color: white;
        }

        /* --- Attractive Dashboard Styles --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .action-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        .main-dashboard-bg {
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.1) 1px, transparent 0);
            background-size: 2rem 2rem;
            animation: bg-pan 30s linear infinite;
        }
        @keyframes bg-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        /* NEW: Mic button listening animation */
        .mic-listening {
            box-shadow: 0 0 15px 5px rgba(229, 9, 20, 0.7);
        }
    </style>
</head>
<body class="tlearn-bg text-white">

    <!-- Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="aurora-container">
            <div class="aurora-element"></div>
            <div class="aurora-element"></div>
            <div class="aurora-element"></div>
        </div>
        <div class="glassmorphism-box p-8 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <h1 class="text-3xl font-bold mb-4">Thanu's Prep Dashboard</h1>
            <p class="text-gray-400 mb-6">Enter Passcode</p>
            <input type="password" id="password-input" class="w-full bg-gray-800 text-white p-3 rounded-md text-center tracking-widest text-2xl border-2 border-transparent transition-all duration-300" maxlength="8">
            <p id="error-message" class="text-red-500 mt-4 hidden">Incorrect Passcode</p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-40 flex items-center justify-center bg-black hidden">
        <div class="text-center p-4">
            <h1 id="welcome-greet" class="text-4xl md:text-6xl font-bold"></h1>
            <p id="welcome-subtext" class="text-xl md:text-2xl text-gray-400 mt-4"></p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden main-dashboard-bg">
        <header class="sticky top-0 z-50 p-4 flex justify-between items-center glass-panel mx-4 mt-4">
             <h1 class="text-3xl font-bold tlearn-red-text"><span class="text-4xl">T</span>LEARN</h1>
             <button id="icon-history-btn" class="bg-gray-700/50 hover:bg-gray-600/50 p-2 rounded-full transition-colors">
                <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             </button>
        </header>

        <main class="p-4 md:p-8">
            <h2 class="text-4xl font-bold mb-8 text-center">What will you conquer today, Thanu?</h2>
            
            <div class="flex items-center justify-center flex-wrap gap-3 mb-8">
                <button id="study-plan-btn" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full text-sm">âœ¨ Study Plan</button>
                <button id="chapter-test-btn" class="action-button bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full text-sm">Chapter Test</button>
                <button id="chapter-exp-btn" class="action-button bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-full text-sm">Chapter Explanation</button>
                <button id="subject-test-btn" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full text-sm">Subject Test</button>
                <button id="mock-test-btn" class="action-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-sm">Full Mock Test</button>
            </div>

            <!-- Search Section -->
            <div class="glass-panel p-6 md:p-10 text-center mb-12">
                <h3 class="text-2xl font-bold mb-4">Explore a Concept</h3>
                <div class="relative max-w-4xl mx-auto">
                    <button id="mic-btn" class="absolute inset-y-0 left-0 pl-4 flex items-center cursor-pointer">
                        <svg class="h-6 w-6 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                    <input type="text" id="search-input" class="w-full bg-gray-800 text-white p-4 rounded-full text-lg focus:outline-none focus:ring-2 focus:ring-red-500 pl-14 pr-10">
                    <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-4 flex items-center cursor-pointer hidden">
                        <svg class="h-6 w-6 text-gray-500 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                 <button id="search-btn" class="w-full md:w-auto mt-4 tlearn-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg">Search</button>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden my-8">
                <div id="gemini-response" class="p-6 glass-panel"></div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="study-plan-modal" class="modal">
        <div class="modal-content">
            <span id="close-study-plan" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">âœ¨ AI Study Plan Generator</h2>
            <div class="space-y-4">
                <div>
                    <label for="study-weeks" class="block text-sm font-medium text-gray-300">Number of Weeks to Study:</label>
                    <input type="number" id="study-weeks" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" value="8">
                </div>
                <div>
                    <label for="study-subjects" class="block text-sm font-medium text-gray-300">Subjects to Focus On (comma-separated):</label>
                    <input type="text" id="study-subjects" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" placeholder="e.g., Physics, Organic Chemistry">
                </div>
                <button id="generate-plan-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md">Generate Plan</button>
            </div>
            <div id="study-plan-output" class="mt-6 p-4 bg-gray-900 rounded-lg min-h-[200px] text-gray-300 whitespace-pre-wrap"></div>
        </div>
    </div>

    <div id="mock-test-modal" class="modal">
        <div class="modal-content">
            <span id="close-mock-test" class="close">&times;</span>
            <div id="mock-test-content"></div>
        </div>
    </div>

    <div id="subject-test-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span id="close-subject-test" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">Choose a Subject</h2>
            <div id="subject-choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button class="subject-choice-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Physics">Physics</button>
                <button class="subject-choice-btn bg-green-600 hover:bg-green-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Chemistry">Chemistry</button>
                <button class="subject-choice-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Botany">Botany</button>
                <button class="subject-choice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-6 rounded-md text-xl" data-subject="Zoology">Zoology</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="close-history" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">My Learning History</h2>
            <div id="history-content"></div>
        </div>
    </div>

    <!-- NEW: Chapter-wise Test Modal -->
    <div id="chapter-test-modal" class="modal">
        <div class="modal-content">
            <span id="close-chapter-test" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">ðŸŽ¯ Chapter-wise Test</h2>
            <div class="space-y-4">
                 <div>
                    <label for="chapter-test-year" class="block text-sm font-medium text-gray-300">Year:</label>
                    <select id="chapter-test-year" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1">
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                    </select>
                </div>
                <div>
                    <label for="chapter-test-subject" class="block text-sm font-medium text-gray-300">Subject:</label>
                    <select id="chapter-test-subject" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <div>
                    <label for="chapter-test-chapter" class="block text-sm font-medium text-gray-300">Chapter:</label>
                    <select id="chapter-test-chapter" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <button id="start-chapter-test-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-md">Start Chapter Test</button>
            </div>
        </div>
    </div>

    <!-- NEW: Chapter-wise Explanation Modal -->
    <div id="chapter-explanation-modal" class="modal">
        <div class="modal-content">
            <span id="close-chapter-explanation" class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center">ðŸ§  Chapter-wise Explanation</h2>
            <div class="space-y-4">
                 <div>
                    <label for="chapter-exp-year" class="block text-sm font-medium text-gray-300">Year:</label>
                    <select id="chapter-exp-year" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1">
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                    </select>
                </div>
                <div>
                    <label for="chapter-exp-subject" class="block text-sm font-medium text-gray-300">Subject:</label>
                    <select id="chapter-exp-subject" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                <div>
                    <label for="chapter-exp-chapter" class="block text-sm font-medium text-gray-300">Chapter:</label>
                    <select id="chapter-exp-chapter" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1"></select>
                </div>
                 <div>
                    <label for="chapter-exp-topic" class="block text-sm font-medium text-gray-300">Specific Topic (Optional):</label>
                    <input type="text" id="chapter-exp-topic" class="w-full bg-gray-800 text-white p-2 rounded-md mt-1" placeholder="e.g., Glycolysis steps">
                </div>
                <button id="get-explanation-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-md">Get Explanation</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Application State ---
        let db, auth, userId, appId;
        let unsubscribeTestHistory, unsubscribeSearchHistory, unsubscribeExplanationHistory;
        let currentTestQuestions = [];
        let combinedHistory = [];
        let timerInterval = null;
        let testStartTime = 0;
        let currentTestType = '';
        let lastGreetingIndex = -1;

        // --- IMPORTANT: API KEY MANAGEMENT ---
        const geminiApiKey = "AIzaSyD_Dxv-dgdv8PYp97-F74dM0day1FEA8Do"; 

        // --- DOM Elements Cache ---
        const ui = {
            passwordInput: document.getElementById('password-input'),
            lockScreen: document.getElementById('lock-screen'),
            welcomeScreen: document.getElementById('welcome-screen'),
            mainDashboard: document.getElementById('main-dashboard'),
            errorMessage: document.getElementById('error-message'),
            welcomeGreet: document.getElementById('welcome-greet'),
            welcomeSubtext: document.getElementById('welcome-subtext'),
            searchBtn: document.getElementById('search-btn'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            micBtn: document.getElementById('mic-btn'),
            resultsSection: document.getElementById('results-section'),
            geminiResponseEl: document.getElementById('gemini-response'),
            mockTestBtn: document.getElementById('mock-test-btn'),
            subjectTestBtn: document.getElementById('subject-test-btn'),
            historyBtn: document.getElementById('icon-history-btn'), // Changed to new icon button
            studyPlanBtn: document.getElementById('study-plan-btn'),
            chapterTestBtn: document.getElementById('chapter-test-btn'),
            chapterExpBtn: document.getElementById('chapter-exp-btn'),
            mockTestModal: document.getElementById('mock-test-modal'),
            subjectTestModal: document.getElementById('subject-test-modal'),
            historyModal: document.getElementById('history-modal'),
            studyPlanModal: document.getElementById('study-plan-modal'),
            chapterTestModal: document.getElementById('chapter-test-modal'),
            chapterExplanationModal: document.getElementById('chapter-explanation-modal'),
            closeMockTest: document.getElementById('close-mock-test'),
            closeSubjectTest: document.getElementById('close-subject-test'),
            closeHistory: document.getElementById('close-history'),
            closeStudyPlan: document.getElementById('close-study-plan'),
            closeChapterTest: document.getElementById('close-chapter-test'),
            closeChapterExplanation: document.getElementById('close-chapter-explanation'),
            mockTestContent: document.getElementById('mock-test-content'),
            subjectChoiceContainer: document.getElementById('subject-choice-container'),
            historyContent: document.getElementById('history-content'),
            generatePlanBtn: document.getElementById('generate-plan-btn'),
            studyPlanOutput: document.getElementById('study-plan-output'),
            studyWeeks: document.getElementById('study-weeks'),
            studySubjects: document.getElementById('study-subjects'),
            chapterTestYear: document.getElementById('chapter-test-year'),
            chapterTestSubject: document.getElementById('chapter-test-subject'),
            chapterTestChapter: document.getElementById('chapter-test-chapter'),
            startChapterTestBtn: document.getElementById('start-chapter-test-btn'),
            chapterExpYear: document.getElementById('chapter-exp-year'),
            chapterExpSubject: document.getElementById('chapter-exp-subject'),
            chapterExpChapter: document.getElementById('chapter-exp-chapter'),
            chapterExpTopic: document.getElementById('chapter-exp-topic'),
            getExplanationBtn: document.getElementById('get-explanation-btn'),
        };

        // NEW: Special greetings for Thanu
        const specialGreetings = [
            { main: "Welcome, Thanu!", sub: "Ready to show those MCQs who's boss?" },
            { main: "Hello, Superstar!", sub: "Another day, another step closer to that white coat." },
            { main: "Thanu is in the house!", sub: "Let's turn that brainpower up to 11." },
            { main: "Hey there, Future Dr. Thanu!", sub: "Your journey is inspiring. Let's keep going!" },
            { main: "It's a great day to study!", sub: "Let's make some magic happen, Thanu." }
        ];

        // NEW: Comprehensive Syllabus Data
        const syllabus = {
            "1st Year": {
                "Physics": ["Units and Measurements", "Motion in a Straight Line", "Motion in a Plane", "Laws of Motion", "Work, Energy and Power", "System of Particles and Rotational Motion", "Gravitation", "Mechanical Properties of Solids", "Mechanical Properties of Fluids", "Thermal Properties of Matter", "Thermodynamics", "Kinetic Theory", "Oscillations", "Waves"],
                "Chemistry": ["Some Basic Concepts of Chemistry", "Structure of Atom", "Classification of Elements and Periodicity in Properties", "Chemical Bonding and Molecular Structure", "States of Matter", "Thermodynamics", "Equilibrium", "Redox Reactions", "Hydrogen", "The s-Block Elements", "The p-Block Elements (Groups 13 & 14)", "Organic Chemistry: Some Basic Principles and Techniques", "Hydrocarbons", "Environmental Chemistry"],
                "Botany": ["The Living World", "Biological Classification", "Plant Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Transport in Plants", "Mineral Nutrition", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development"],
                "Zoology": ["Animal Kingdom", "Structural Organisation in Animals", "Digestion and Absorption", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"]
            },
            "2nd Year": {
                "Physics": ["Electric Charges and Fields", "Electrostatic Potential and Capacitance", "Current Electricity", "Moving Charges and Magnetism", "Magnetism and Matter", "Electromagnetic Induction", "Alternating Current", "Electromagnetic Waves", "Ray Optics and Optical Instruments", "Wave Optics", "Dual Nature of Radiation and Matter", "Atoms", "Nuclei", "Semiconductor Electronics: Materials, Devices and Simple Circuits"],
                "Chemistry": ["The Solid State", "Solutions", "Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "General Principles and Processes of Isolation of Elements", "The p-Block Elements (Groups 15-18)", "The d- and f-Block Elements", "Coordination Compounds", "Haloalkanes and Haloarenes", "Alcohols, Phenols and Ethers", "Aldehydes, Ketones and Carboxylic Acids", "Amines", "Biomolecules", "Polymers", "Chemistry in Everyday Life"],
                "Botany": ["Reproduction in Organisms", "Sexual Reproduction in Flowering Plants", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"],
                "Zoology": ["Human Reproduction", "Reproductive Health", "Evolution", "Human Health and Disease", "Strategies for Enhancement in Food Production", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation", "Environmental Issues"]
            }
        };

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            ui.passwordInput.addEventListener('input', (e) => {
                if (e.target.value.length === 8) handleLogin(e.target.value);
            });
            ui.searchBtn.addEventListener('click', handleSearch);
            
            // Search input listeners for clear button and mic
            ui.searchInput.addEventListener('input', () => {
                ui.clearSearchBtn.classList.toggle('hidden', ui.searchInput.value === '');
            });
            ui.clearSearchBtn.addEventListener('click', handleClearSearch);
            ui.micBtn.addEventListener('click', handleVoiceSearch);

            // Action Card / Button listeners
            ui.mockTestBtn.addEventListener('click', () => {
                resetFullTestModal();
                ui.mockTestModal.style.display = 'block';
            });
            ui.subjectTestBtn.addEventListener('click', () => ui.subjectTestModal.style.display = 'block');
            ui.subjectChoiceContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('subject-choice-btn')) {
                    const subject = e.target.dataset.subject;
                    ui.subjectTestModal.style.display = 'none';
                    startSubjectTest(subject);
                }
            });
            ui.historyBtn.addEventListener('click', () => ui.historyModal.style.display = 'block');
            ui.studyPlanBtn.addEventListener('click', () => ui.studyPlanModal.style.display = 'block');
            ui.generatePlanBtn.addEventListener('click', handleGenerateStudyPlan);
            
            // New Chapter-wise buttons
            ui.chapterTestBtn.addEventListener('click', () => ui.chapterTestModal.style.display = 'block');
            ui.chapterExpBtn.addEventListener('click', () => ui.chapterExplanationModal.style.display = 'block');
            ui.startChapterTestBtn.addEventListener('click', startChapterTest);
            ui.getExplanationBtn.addEventListener('click', handleChapterExplanation);

            // Modal close buttons
            ui.closeMockTest.addEventListener('click', () => ui.mockTestModal.style.display = 'none');
            ui.closeSubjectTest.addEventListener('click', () => ui.subjectTestModal.style.display = 'none');
            ui.closeHistory.addEventListener('click', () => ui.historyModal.style.display = 'none');
            ui.closeStudyPlan.addEventListener('click', () => ui.studyPlanModal.style.display = 'none');
            ui.closeChapterTest.addEventListener('click', () => ui.chapterTestModal.style.display = 'none');
            ui.closeChapterExplanation.addEventListener('click', () => ui.chapterExplanationModal.style.display = 'none');
            
            // Close modal on outside click
            window.addEventListener('click', (event) => {
                const modals = [ui.mockTestModal, ui.historyModal, ui.subjectTestModal, ui.studyPlanModal, ui.chapterTestModal, ui.chapterExplanationModal];
                modals.forEach(modal => {
                    if (event.target == modal) modal.style.display = 'none';
                });
            });

            // Dynamic filter listeners
            ui.chapterTestYear.addEventListener('change', () => populateFilters('chapter-test'));
            ui.chapterTestSubject.addEventListener('change', () => populateFilters('chapter-test'));
            ui.chapterExpYear.addEventListener('change', () => populateFilters('chapter-exp'));
            ui.chapterExpSubject.addEventListener('change', () => populateFilters('chapter-exp'));
        }

        // --- Core Application Logic ---

        function getPersonalizedGreeting() {
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * specialGreetings.length);
            } while (newIndex === lastGreetingIndex);
            lastGreetingIndex = newIndex;
            return specialGreetings[newIndex];
        }

        async function handleLogin(password) {
            if (password === '02102008') {
                await initFirebase(); 
                ui.lockScreen.style.opacity = 0;
                setTimeout(() => ui.lockScreen.classList.add('hidden'), 500);
                
                const { main, sub } = getPersonalizedGreeting();
                ui.welcomeGreet.textContent = main;
                ui.welcomeSubtext.textContent = sub;
                ui.welcomeGreet.classList.add('fade-in-down');
                ui.welcomeSubtext.classList.add('fade-in-up');
                ui.welcomeScreen.classList.remove('hidden');
                
                setTimeout(() => {
                    ui.welcomeScreen.classList.add('hidden');
                    ui.mainDashboard.classList.remove('hidden');
                    populateFilters('chapter-test');
                    populateFilters('chapter-exp');
                }, 20000); // Increased to 20 seconds
            } else {
                ui.errorMessage.classList.remove('hidden');
                ui.passwordInput.value = '';
                setTimeout(() => ui.errorMessage.classList.add('hidden'), 2000);
            }
        }

        async function initFirebase() {
            try {
                // This configuration is for client-side initialization
                const firebaseConfig = {
                  apiKey: "AIzaSyCjtncOkpemPxuaEoQ6mRD_Sc99YQ-G7ig",
                  authDomain: "tanu-neet-dashboard.firebaseapp.com",
                  projectId: "tanu-neet-dashboard",
                  storageBucket: "tanu-neet-dashboard.firebasestorage.app",
                  messagingSenderId: "911874194562",
                  appId: "1:911874194562:web:fb8b2fbb2d737d52e3c89b",
                  measurementId: "G-CYNCVKV6Y2"
                };

                appId = firebaseConfig.projectId;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid;
                if (!userId) throw new Error("Authentication failed, user ID is not available.");
                
                setupHistoryListeners();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                let userErrorMessage = "Could not connect to the database. Please check your Firebase configuration and refresh.";
                ui.mainDashboard.innerHTML = `<div class="p-8"><p class="text-red-500 text-center">${userErrorMessage}</p></div>`;
            }
        }

        // --- API Interaction ---

        async function fetchApiResponse(url, payload, options = {}) {
            const { timeout = 60000, retries = 3, onRetryMessage } = options;
            
            if (geminiApiKey === "YOUR_GEMINI_API_KEY") {
                throw new Error("Gemini API key is missing. Please add your key to the script to use AI features.");
            }

            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: controller.signal 
                    });
                    
                    clearTimeout(id);
                    
                    if (response.status === 503) {
                        throw new Error("API service is currently unavailable (503).");
                    }
                    
                    if (response.status === 400) {
                        throw new Error("API request failed with status 400 (Bad Request). This is often due to an invalid API key or a problem with the AI model's input.");
                    }
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return await response.json(); // Success
                } catch (error) {
                    lastError = error;
                    if (error.name === 'AbortError') {
                        throw new Error('The request to the AI service timed out. Please try again.');
                    }
                    
                    if (i < retries - 1 && error.message && error.message.includes("503")) {
                        const delay = Math.pow(2, i) * 1000;
                        if(onRetryMessage) onRetryMessage(`AI service is busy, retrying in ${delay / 1000}s... (Attempt ${i + 2})`);
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw lastError;
                    }
                }
            }
        }

        function safeJsonParse(jsonText) {
            if (typeof jsonText !== 'string') {
                if (typeof jsonText === 'object' && jsonText !== null) return jsonText;
                throw new Error("Invalid input to safeJsonParse: not a string.");
            }
            try {
                let cleanedText = jsonText.trim();
                
                if (cleanedText.startsWith("```json")) {
                    cleanedText = cleanedText.substring(7).trim();
                }
                if (cleanedText.endsWith("```")) {
                    cleanedText = cleanedText.slice(0, -3).trim();
                }

                const firstChar = cleanedText.charAt(0);
                const lastChar = cleanedText.charAt(cleanedText.length - 1);

                if ((firstChar === '{' && lastChar === '}') || (firstChar === '[' && lastChar === ']')) {
                    return JSON.parse(cleanedText);
                }
                
                const startIndex = cleanedText.indexOf('[');
                const startIndexObj = cleanedText.indexOf('{');

                if (startIndex === -1 && startIndexObj === -1) {
                    throw new Error("No JSON object or array found in the response.");
                }

                let finalJsonText;
                if (startIndex !== -1 && (startIndex < startIndexObj || startIndexObj === -1)) {
                    const endIndex = cleanedText.lastIndexOf(']');
                    if (endIndex > startIndex) {
                        finalJsonText = cleanedText.substring(startIndex, endIndex + 1);
                    }
                } else if (startIndexObj !== -1) {
                    const endIndex = cleanedText.lastIndexOf('}');
                    if (endIndex > startIndexObj) {
                        finalJsonText = cleanedText.substring(startIndexObj, endIndex + 1);
                    }
                }

                if (!finalJsonText) {
                    throw new Error("Could not extract a valid JSON structure from the response.");
                }

                return JSON.parse(finalJsonText);
            } catch (e) {
                console.error("JSON Parsing Error:", e, "Raw text:", jsonText);
                throw new Error("The AI model returned an invalid JSON format. Please try again.");
            }
        }

        // --- Feature Handlers ---

        function handleClearSearch() {
            ui.searchInput.value = '';
            ui.geminiResponseEl.innerHTML = '';
            ui.resultsSection.classList.add('hidden');
            ui.clearSearchBtn.classList.add('hidden');
        }

        function handleVoiceSearch() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Sorry, your browser doesn't support voice recognition.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            ui.micBtn.classList.add('mic-listening');

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                ui.searchInput.value = speechResult;
                ui.clearSearchBtn.classList.remove('hidden');
                handleSearch(); // Automatically search after speech
            };

            recognition.onspeechend = () => {
                recognition.stop();
                ui.micBtn.classList.remove('mic-listening');
            };

            recognition.onerror = (event) => {
                alert(`Error occurred in recognition: ${event.error}`);
                ui.micBtn.classList.remove('mic-listening');
            };
            
            recognition.start();
        }

        async function handleSearch() {
            const query = ui.searchInput.value.trim();
            if (!query || !userId) return;
            
            ui.searchBtn.disabled = true;
            ui.searchBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;
            ui.resultsSection.classList.remove('hidden');
            ui.geminiResponseEl.innerHTML = '<p>Loading explanation from AI...</p>';
            
            const structuredPrompt = `For the NEET concept "${query}", provide a response as a valid JSON object. The object must have "shortAnswer" (2-3 sentences) and "detailedAnswer". If the concept is from Physics or Chemistry and involves a formula or principle that can be derived, also include a "derivation" key with the step-by-step derivation. If no derivation is applicable, set "derivation" to null.`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: structuredPrompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            try {
                const result = await fetchApiResponse(apiUrl, payload, { 
                    onRetryMessage: (msg) => ui.geminiResponseEl.innerHTML = `<p>${msg}</p>` 
                });
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Received an empty response from the AI service.");
                
                const data = safeJsonParse(jsonText);
                renderStructuredResponse(ui.geminiResponseEl, data, query);
                
                // Save to history
                const historyData = { type: 'search', query, response: JSON.stringify(data), timestamp: Date.now() };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/searchHistory`), historyData);

            } catch (error) {
                 ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                ui.searchBtn.disabled = false;
                ui.searchBtn.innerHTML = 'Search';
            }
        }
        
        async function handleGenerateStudyPlan() {
            const weeks = ui.studyWeeks.value;
            const subjects = ui.studySubjects.value;
            ui.studyPlanOutput.innerHTML = 'Generating your personalized study plan...';

            const prompt = `Create a detailed, day-by-day study plan for a student for ${weeks} weeks, focusing on: ${subjects || 'all subjects'}. Format it clearly.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const result = await fetchApiResponse(apiUrl, payload, { 
                    timeout: 90000,
                    onRetryMessage: (msg) => ui.studyPlanOutput.innerHTML = `<p>${msg}</p>`
                });
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                ui.studyPlanOutput.innerHTML = text.replace(/\*/g, '');
            } catch (error) {
                ui.studyPlanOutput.innerHTML = `<p class="text-red-400">Error generating plan: ${error.message}</p>`;
            }
        }
        
        async function handleChapterExplanation() {
            const year = ui.chapterExpYear.value;
            const subject = ui.chapterExpSubject.value;
            const chapter = ui.chapterExpChapter.value;
            const topic = ui.chapterExpTopic.value.trim();
            const query = topic ? `${topic} from the chapter ${chapter}` : `the chapter ${chapter}`;

            ui.chapterExplanationModal.style.display = 'none';
            ui.resultsSection.classList.remove('hidden');
            ui.geminiResponseEl.innerHTML = `<p>Loading explanation for ${query}...</p>`;

            const prompt = `Provide a detailed explanation for the NEET topic: "${query}". If the concept is visual (e.g., cell structure, a physics diagram, a chemical reaction mechanism), please include a simplified SVG diagram string within the JSON response. The JSON object must have keys: "topic" (string), "explanation" (string), and "svgDiagram" (string, or null if not applicable).`;
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const result = await fetchApiResponse(apiUrl, payload, { 
                    onRetryMessage: (msg) => ui.geminiResponseEl.innerHTML = `<p>${msg}</p>` 
                });
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Received an empty response from the AI service.");
                
                renderExplanationWithDiagram(ui.geminiResponseEl, jsonText, query);
                
                // Save to history
                const historyData = { type: 'explanation', query, response: jsonText, timestamp: Date.now() };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/explanationHistory`), historyData);

            } catch (error) {
                 ui.geminiResponseEl.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }


        // --- Mock Test Logic ---

        async function startFullTest() {
            currentTestType = 'Full Mock Test';
            const paper = prepareTestUI();
            paper.innerHTML = '<p>Generating unique full test... This will take a moment.</p>';
            
            try {
                const subjects = ['Physics', 'Chemistry', 'Botany', 'Zoology'];
                const questionPromises = subjects.map(subject => generateQuestionsForSubject(subject, 45, paper));
                const questionSets = await Promise.all(questionPromises);
                currentTestQuestions = questionSets.flat();
                displayQuestions(currentTestQuestions);
                startTimer(180);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }

        async function startSubjectTest(subject) {
            currentTestType = `Subject Test: ${subject}`;
            ui.mockTestModal.style.display = 'block';
            const paper = prepareTestUI(true);
            paper.innerHTML = `<p>Generating unique ${subject} test...</p>`;
            try {
                currentTestQuestions = await generateQuestionsForSubject(subject, 45, paper);
                displayQuestions(currentTestQuestions);
                startTimer(45);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }
        
        async function startChapterTest() {
            const year = ui.chapterTestYear.value;
            const subject = ui.chapterTestSubject.value;
            const chapter = ui.chapterTestChapter.value;
            currentTestType = `Chapter Test: ${chapter}`;
            ui.chapterTestModal.style.display = 'none';
            ui.mockTestModal.style.display = 'block';
            const paper = prepareTestUI(true);
            paper.innerHTML = `<p>Generating test for ${chapter}...</p>`;
            try {
                currentTestQuestions = await generateQuestionsForSubject(subject, 20, paper, chapter); // Generate 20 questions for a chapter test
                displayQuestions(currentTestQuestions);
                startTimer(20);
            } catch (error) {
                handleTestGenerationError(paper, error);
            }
        }
        
        async function generateQuestionsForSubject(subject, count, paperElement, chapter = null) {
            const topic = chapter ? `from the chapter "${chapter}"` : `from various chapters`;
            const prompt = `Generate ${count} unique, high-quality multiple-choice questions for the NEET exam on the subject of ${subject}, focusing on topics ${topic}. Format as a valid JSON array of objects, with keys: "question", "options" (array of 4 strings), "answer" (string "A", "B", "C", or "D"), and "subject" ("${subject}").`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const result = await fetchApiResponse(url, payload, { 
                onRetryMessage: (msg) => paperElement.innerHTML = `<p>${msg}</p>` 
            });
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("Received empty question set from AI.");
            return safeJsonParse(jsonText);
        }

        async function handleSubmitTest() {
            clearInterval(timerInterval);
            const timeTakenMs = Date.now() - testStartTime;
            let score = 0, correctCount = 0, incorrectCount = 0, unattemptedCount = 0;
            const userAnswers = [];

            currentTestQuestions.forEach((q, index) => {
                const selected = document.querySelector(`#mock-test-content input[name="q${index}"]:checked`);
                const answer = selected ? selected.value : null;
                userAnswers.push(answer);
                if (answer) {
                    if (answer === q.answer) { score += 4; correctCount++; } 
                    else { score -= 1; incorrectCount++; }
                } else {
                    unattemptedCount++;
                }
            });

            const testResult = {
                timestamp: Date.now(),
                type: 'test', // Unified type for all tests
                testName: currentTestType,
                timeTaken: formatTime(timeTakenMs),
                score, correctCount, incorrectCount, unattemptedCount,
                questions: JSON.stringify(currentTestQuestions), 
                userAnswers: JSON.stringify(userAnswers)
            };
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/testHistory`), testResult);
            } catch(error) {
                console.error("Error saving mock test result:", error);
            }

            displayResults({ ...testResult, questions: currentTestQuestions, userAnswers });
        }

        // --- UI Rendering & Updates ---

        function renderStructuredResponse(element, data, query) {
            if (typeof data === 'object' && data !== null && data.shortAnswer && data.detailedAnswer) {
                const derivationHtml = data.derivation ? `
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-yellow-400 mb-2">Derivation</h3>
                        <div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.derivation.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                    </div>` : '';
                element.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-400 mb-2">Quick Summary</h3>
                    <div class="bg-gray-700 p-4 rounded-lg text-gray-300">${data.shortAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-green-400 mb-2">Detailed Explanation</h3>
                        <div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">${data.detailedAnswer.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                    </div>
                    ${derivationHtml}`;
            } else {
                const rawText = (typeof data === 'object' && data !== null) ? JSON.stringify(data, null, 2) : String(data);
                element.innerHTML = `
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Explanation for ${query}</h2>
                    <p class="text-sm text-yellow-400 mb-4">(The AI response was not in the expected structured format, so it is displayed below as raw text.)</p>
                    <pre class="bg-gray-900 p-4 rounded-lg text-gray-300 whitespace-pre-wrap">${rawText.replace(/\*/g, '').replace(/\\n/g, '\n')}</pre>`;
            }
        }

        function renderExplanationWithDiagram(element, responseText, query) {
            try {
                const data = safeJsonParse(responseText);
                const diagramHtml = data.svgDiagram ? `
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-yellow-400 mb-2">Diagram</h3>
                        <div class="bg-white p-4 rounded-lg flex justify-center items-center">
                            ${data.svgDiagram}
                        </div>
                    </div>` : '';
                element.innerHTML = `
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">${data.topic}</h2>
                    <div class="bg-gray-900 p-4 rounded-lg text-gray-300 space-y-4">
                        ${data.explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}
                    </div>
                    ${diagramHtml}`;
            } catch (error) {
                // If parsing fails, render the raw text as a fallback.
                element.innerHTML = `
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Explanation for ${query}</h2>
                    <p class="text-sm text-yellow-400 mb-4">(The AI response was not in the expected structured format, so it is displayed below as raw text.)</p>
                    <pre class="bg-gray-900 p-4 rounded-lg text-gray-300 whitespace-pre-wrap">${responseText.replace(/\*/g, '').replace(/\\n/g, '\n')}</pre>`;
            }
        }

        function resetFullTestModal() {
            ui.mockTestContent.innerHTML = `
                <div id="mock-test-instructions">
                    <h2 class="text-2xl font-bold mb-4">NEET Full Mock Test</h2>
                    <ul class="list-disc list-inside text-gray-300 space-y-2">
                        <li>180 multiple-choice questions.</li>
                        <li>+4 for correct, -1 for incorrect.</li>
                        <li>Duration: <strong>3 hours</strong>.</li>
                    </ul>
                    <button id="start-full-test-btn" class="mt-6 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Start Full Test</button>
                </div>
                <div id="mock-test-paper" class="hidden mt-6"></div>`;
            document.getElementById('start-full-test-btn').addEventListener('click', startFullTest);
        }

        function prepareTestUI(isSubjectTest = false) {
            if (isSubjectTest) {
                ui.mockTestContent.innerHTML = '<div id="mock-test-paper"></div>';
            } else {
                const instructions = ui.mockTestContent.querySelector('#mock-test-instructions');
                if (instructions) instructions.classList.add('hidden');
            }
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            paper.classList.remove('hidden');
            return paper;
        }

        function handleTestGenerationError(paperElement, error) {
            let errorMessage = `Failed to generate the test: ${error.message}. Please try again.`;
            paperElement.innerHTML = `<p class="text-red-400">${errorMessage}</p>`;
        }

        function displayQuestions(questions) {
            const paper = ui.mockTestContent.querySelector('#mock-test-paper');
            let questionsHtml = `<div class="sticky top-0 tlearn-bg py-2 z-10 flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">${currentTestType}</h2>
                                    <div id="timer-display" class="text-2xl font-bold tlearn-red-text font-mono"></div>
                                </div>`;
            questions.forEach((q, index) => {
                questionsHtml += `<div class="mb-6"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2" id="q-${index}">
                    ${q.options.map((opt, i) => `<div><input type="radio" id="q${index}opt${i}" name="q${index}" value="${String.fromCharCode(65 + i)}"><label for="q${index}opt${i}" class="ml-2">${String.fromCharCode(65 + i)}) ${opt}</label></div>`).join('')}
                </div></div>`;
            });
            questionsHtml += `<button id="submit-test-btn" class="mt-8 w-full tlearn-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md">Submit Test</button>`;
            paper.innerHTML = questionsHtml;
            document.getElementById('submit-test-btn').addEventListener('click', handleSubmitTest);
        }

        async function handleAllExplanations(result) {
            const explanationsContainer = document.getElementById('explanations-container');
            explanationsContainer.innerHTML = `<p class="text-center text-yellow-400">Generating explanations for all questions... This may take a moment.</p>`;
            
            const prompt = `For the following list of multiple-choice questions, provide a clear, concise explanation for each one, explaining why the correct answer is right. Format the response as a valid JSON array of objects, where each object has a "question" key (matching the original question text) and an "explanation" key. Here are the questions: ${JSON.stringify(result.questions)}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const apiResult = await fetchApiResponse(apiUrl, payload, {
                    timeout: 180000, // 3-minute timeout for all explanations
                    onRetryMessage: (msg) => explanationsContainer.innerHTML = `<p>${msg}</p>`
                });
                const explanations = safeJsonParse(apiResult.candidates?.[0]?.content?.parts?.[0]?.text);
                
                const explanationMap = new Map();
                explanations.forEach(exp => {
                    explanationMap.set(exp.question, exp.explanation);
                });

                result.questions.forEach((q, index) => {
                    const questionContainer = document.getElementById(`question-review-${index}`);
                    if (questionContainer) {
                        const explanation = explanationMap.get(q.question);
                        if (explanation) {
                            const explanationDiv = document.createElement('div');
                            explanationDiv.className = 'mt-4 p-3 bg-gray-900 border-l-2 border-blue-500 rounded-r-lg';
                            explanationDiv.innerHTML = `<h4 class="font-semibold text-blue-300">Explanation:</h4><p class="text-gray-300">${explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}</p>`;
                            questionContainer.appendChild(explanationDiv);
                        }
                    }
                });
                document.getElementById('explanation-buttons').style.display = 'none';

            } catch (error) {
                explanationsContainer.innerHTML = `<p class="text-red-400">Error generating explanations: ${error.message}</p>`;
            }
        }

        async function handleMistakeExplanations(result) {
            const explanationsContainer = document.getElementById('explanations-container');
            explanationsContainer.innerHTML = `<p class="text-center text-yellow-400">Generating explanations for your mistakes...</p>`;
            
            const incorrectQuestions = [];
            result.questions.forEach((q, index) => {
                if (result.userAnswers[index] && result.userAnswers[index] !== q.answer) {
                    incorrectQuestions.push({
                        question: q.question,
                        options: q.options,
                        yourAnswer: result.userAnswers[index],
                        correctAnswer: q.answer
                    });
                }
            });

            const prompt = `For the following list of multiple-choice questions, I made mistakes. Please provide a clear, concise explanation for each one, explaining why my answer was wrong and the correct answer is right. Format the response as a valid JSON array of objects, where each object has a "question" key and an "explanation" key. Here are my mistakes: ${JSON.stringify(incorrectQuestions)}`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const apiResult = await fetchApiResponse(apiUrl, payload, {
                    timeout: 120000, 
                    onRetryMessage: (msg) => explanationsContainer.innerHTML = `<p>${msg}</p>`
                });
                const explanations = safeJsonParse(apiResult.candidates?.[0]?.content?.parts?.[0]?.text);
                
                const explanationMap = new Map();
                explanations.forEach(exp => {
                    explanationMap.set(exp.question, exp.explanation);
                });

                result.questions.forEach((q, index) => {
                    if (result.userAnswers[index] && result.userAnswers[index] !== q.answer) {
                        const questionContainer = document.getElementById(`question-review-${index}`);
                        if (questionContainer) {
                            const explanation = explanationMap.get(q.question);
                            if (explanation) {
                                const explanationDiv = document.createElement('div');
                                explanationDiv.className = 'mt-4 p-3 bg-gray-900 border-l-2 border-yellow-500 rounded-r-lg';
                                explanationDiv.innerHTML = `<h4 class="font-semibold text-yellow-300">Explanation:</h4><p class="text-gray-300">${explanation.replace(/\*/g, '').replace(/\n/g, '<br>')}</p>`;
                                questionContainer.appendChild(explanationDiv);
                            }
                        }
                    }
                });
                document.getElementById('explanation-buttons').style.display = 'none';

            } catch (error) {
                explanationsContainer.innerHTML = `<p class="text-red-400">Error generating explanations: ${error.message}</p>`;
            }
        }

        function displayResults(result) {
            const questions = safeJsonParse(result.questions);
            const userAnswers = safeJsonParse(result.userAnswers);

            let buttonsHtml = `<div id="explanation-buttons" class="space-y-4">`;
            buttonsHtml += `<button id="explain-all-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md">âœ¨ Generate Explanations for All Questions</button>`;
            if (result.incorrectCount > 0) {
                buttonsHtml += `<button id="explain-mistakes-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 px-6 rounded-md">ðŸ¤” Explain My Mistakes</button>`;
            }
            buttonsHtml += `</div>`;

            let resultsHtml = `<h2 class="text-3xl font-bold mb-4">${result.testName || result.type} - Results</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-8">
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.score}</p><p>Score</p></div>
                    <div class="bg-green-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.correctCount}</p><p>Correct</p></div>
                    <div class="bg-red-700 p-4 rounded-lg"><p class="text-2xl font-bold">${result.incorrectCount}</p><p>Incorrect</p></div>
                    <div class="bg-gray-600 p-4 rounded-lg"><p class="text-2xl font-bold">${result.unattemptedCount}</p><p>Unattempted</p></div>
                </div>
                <p class="text-center text-lg mb-6">Time Taken: <strong>${result.timeTaken}</strong></p>
                ${buttonsHtml}
                <div id="explanations-container" class="mt-4"></div>
                <h3 class="text-2xl font-bold mb-4 mt-6">Review Answers</h3>`;
            
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                let optionsHtml = q.options.map((opt, i) => {
                    const optionLetter = String.fromCharCode(65 + i);
                    let labelClass = '';
                    if (optionLetter === q.answer) labelClass = 'correct-answer';
                    else if (optionLetter === userAnswer) labelClass = 'incorrect-answer';
                    return `<div><label class="ml-2 ${labelClass}">${optionLetter}) ${opt}</label></div>`;
                }).join('');
                resultsHtml += `<div id="question-review-${index}" class="mb-6 p-4 bg-gray-800 rounded-lg"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="mt-2 space-y-2">${optionsHtml}</div></div>`;
            });
            ui.mockTestContent.innerHTML = resultsHtml;

            document.getElementById('explain-all-btn').addEventListener('click', () => handleAllExplanations({ ...result, questions, userAnswers }));
            if (result.incorrectCount > 0) {
                document.getElementById('explain-mistakes-btn').addEventListener('click', () => handleMistakeExplanations({ ...result, questions, userAnswers }));
            }
        }
        
        function populateFilters(type) {
            const camelCaseType = type.replace(/-(\w)/g, (_, c) => c.toUpperCase());
            const yearDropdown = ui[`${camelCaseType}Year`];
            const subjectDropdown = ui[`${camelCaseType}Subject`];
            const chapterDropdown = ui[`${camelCaseType}Chapter`];

            if(!yearDropdown || !subjectDropdown || !chapterDropdown) return;

            const year = yearDropdown.value;
            const currentSubject = subjectDropdown.value;
            
            subjectDropdown.innerHTML = '';
            Object.keys(syllabus[year]).forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                if (subject === currentSubject) {
                    option.selected = true;
                }
                subjectDropdown.appendChild(option);
            });

            const selectedSubject = subjectDropdown.value || Object.keys(syllabus[year])[0];
            chapterDropdown.innerHTML = '';
            syllabus[year][selectedSubject].forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterDropdown.appendChild(option);
            });
        }
        
        function setupHistoryListeners() {
            if (!userId) return;
            // Unsubscribe from old listeners if they exist
            if (unsubscribeTestHistory) unsubscribeTestHistory();
            if (unsubscribeSearchHistory) unsubscribeSearchHistory();
            if (unsubscribeExplanationHistory) unsubscribeExplanationHistory();

            const testHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/testHistory`);
            const searchHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/searchHistory`);
            const explanationHistoryCol = collection(db, `artifacts/${appId}/users/${userId}/explanationHistory`);

            const updateCombinedHistory = () => {
                const tests = testHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const searches = searchHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const explanations = explanationHistory.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                combinedHistory = [...tests, ...searches, ...explanations].sort((a, b) => b.timestamp - a.timestamp);
                renderHistory();
            };

            let testHistory = { docs: [] };
            let searchHistory = { docs: [] };
            let explanationHistory = { docs: [] };

            unsubscribeTestHistory = onSnapshot(query(testHistoryCol, orderBy("timestamp", "desc")), (snapshot) => {
                testHistory = snapshot;
                updateCombinedHistory();
            });
            unsubscribeSearchHistory = onSnapshot(query(searchHistoryCol, orderBy("timestamp", "desc")), (snapshot) => {
                searchHistory = snapshot;
                updateCombinedHistory();
            });
            unsubscribeExplanationHistory = onSnapshot(query(explanationHistoryCol, orderBy("timestamp", "desc")), (snapshot) => {
                explanationHistory = snapshot;
                updateCombinedHistory();
            });
        }

        function renderHistory() {
            ui.historyContent.innerHTML = '';
            if (!combinedHistory || combinedHistory.length === 0) {
                 ui.historyContent.innerHTML = '<p class="text-gray-400">No history yet. Take a test or search for a concept to get started!</p>';
                 return;
            }

            const groupedByDate = combinedHistory.reduce((acc, result) => {
                const date = new Date(result.timestamp).toLocaleDateString('en-CA'); 
                if (!acc[date]) acc[date] = [];
                acc[date].push(result);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(dateStr => {
                const dateHeading = document.createElement('h3');
                dateHeading.className = 'text-lg font-semibold mt-4 mb-2 text-gray-400';
                
                const today = new Date().toLocaleDateString('en-CA');
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (dateStr === today) {
                    dateHeading.textContent = 'Today';
                } else if (dateStr === yesterday.toLocaleDateString('en-CA')) {
                    dateHeading.textContent = 'Yesterday';
                } else {
                    dateHeading.textContent = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
                ui.historyContent.appendChild(dateHeading);

                groupedByDate[dateStr].forEach(item => {
                    const record = document.createElement('div');
                    record.className = 'p-4 bg-gray-700 rounded-md mb-3 flex justify-between items-center';
                    const itemTime = new Date(item.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    
                    let itemHtml = '';
                    if (item.type === 'test') {
                        itemHtml = `<div><p class="font-bold">${item.testName}</p><p>Score: ${item.score}</p></div>`;
                    } else if (item.type === 'search') {
                        itemHtml = `<div><p class="font-bold">Searched:</p><p>${item.query}</p></div>`;
                    } else if (item.type === 'explanation') {
                        itemHtml = `<div><p class="font-bold">Explained:</p><p>${item.query}</p></div>`;
                    }
                    
                    record.innerHTML = `${itemHtml}<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">View</button>`;
                    
                    record.querySelector('button').addEventListener('click', () => {
                        ui.historyModal.style.display = 'none';
                        if (item.type === 'test') {
                            ui.mockTestModal.style.display = 'block';
                            displayResults(item);
                        } else {
                            ui.resultsSection.classList.remove('hidden');
                            if (item.type === 'search') {
                                renderStructuredResponse(ui.geminiResponseEl, JSON.parse(item.response), item.query);
                            } else if (item.type === 'explanation') {
                                renderExplanationWithDiagram(ui.geminiResponseEl, item.response, item.query);
                            }
                        }
                    });
                    ui.historyContent.appendChild(record);
                });
            });
        }

        // --- Utility Functions ---
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}m ${seconds}s`;
        }
        
        function startTimer(durationInMinutes) {
            clearInterval(timerInterval);
            testStartTime = Date.now();
            const endTime = testStartTime + durationInMinutes * 60 * 1000;
            timerInterval = setInterval(() => {
                const distance = endTime - Date.now();
                const timerDisplay = document.getElementById('timer-display');
                if (distance < 0) {
                    clearInterval(timerInterval);
                    if (timerDisplay) timerDisplay.innerHTML = "Time's Up!";
                    document.getElementById('submit-test-btn')?.click();
                    return;
                }
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if (timerDisplay) timerDisplay.innerHTML = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- Initializer ---
        setupEventListeners();

    </script>
</body>
</html>
